<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta property="og:image" content="https://raw.githubusercontent.com/demanejar/image-collection/main/crawldataalonhadata/img_603b96633d2d0.png"> <script async src="https://www.googletagmanager.com/gtag/js?id=G-9TR0K3B846"></script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8714452693053438" crossorigin="anonymous"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-9TR0K3B846'); </script><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="Cấu hình proxy cho project Scrapy" /><meta name="author" content="trannguyenhan" /><meta property="og:locale" content="en_US" /><meta name="description" content="Proxy chắc là khái niệm đã không còn xa lạ gì với tất cả mọi người. Với người làm về crawl dữ liệu thì proxy như vật bất ly thân. Trong bài viết này, mình sẽ hướng dẫn cách cấu hình proxy cho project Scrapy. Project mình sử dụng để làm ví dụ cho bài viết này là project crawl alonhadat https://github.com/demanejar/crawl-alonhadat." /><meta property="og:description" content="Proxy chắc là khái niệm đã không còn xa lạ gì với tất cả mọi người. Với người làm về crawl dữ liệu thì proxy như vật bất ly thân. Trong bài viết này, mình sẽ hướng dẫn cách cấu hình proxy cho project Scrapy. Project mình sử dụng để làm ví dụ cho bài viết này là project crawl alonhadat https://github.com/demanejar/crawl-alonhadat." /><link rel="canonical" href="https://demanejar.github.io/posts/add-proxy-to-scrapy-project/" /><meta property="og:url" content="https://demanejar.github.io/posts/add-proxy-to-scrapy-project/" /><meta property="og:site_name" content="De Manejar" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-02-15T20:52:00+07:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Cấu hình proxy cho project Scrapy" /><meta name="twitter:site" content="@DeManejar" /><meta name="twitter:creator" content="@trannguyenhan" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"trannguyenhan"},"dateModified":"2025-03-17T06:29:35+07:00","datePublished":"2023-02-15T20:52:00+07:00","description":"Proxy chắc là khái niệm đã không còn xa lạ gì với tất cả mọi người. Với người làm về crawl dữ liệu thì proxy như vật bất ly thân. Trong bài viết này, mình sẽ hướng dẫn cách cấu hình proxy cho project Scrapy. Project mình sử dụng để làm ví dụ cho bài viết này là project crawl alonhadat https://github.com/demanejar/crawl-alonhadat.","headline":"Cấu hình proxy cho project Scrapy","mainEntityOfPage":{"@type":"WebPage","@id":"https://demanejar.github.io/posts/add-proxy-to-scrapy-project/"},"url":"https://demanejar.github.io/posts/add-proxy-to-scrapy-project/"}</script><title>Cấu hình proxy cho project Scrapy | De Manejar</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script> /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */ MathJax = { tex: { inlineMath: [ /* start/end delimiter pairs for in-line math */ ['$','$'], ['\\(','\\)'] ], displayMath: [ /* start/end delimiter pairs for display math */ ['$$', '$$'], ['\\[', '\\]'] ] } }; </script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"> </script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://i.pinimg.com/564x/9c/32/79/9c3279b5ac960533cbcb7e833ac4d947.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">De Manejar</a></div><div class="site-subtitle font-italic">Hello Bigdata !</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/demanejar" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/DeManejar" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['demanejar','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Cấu hình proxy cho project Scrapy</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Cấu hình proxy cho project Scrapy</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> trannguyenhan </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Wed, Feb 15, 2023, 8:52 PM +0700" prep="on" > Feb 15, 2023 <i class="unloaded">2023-02-15T20:52:00+07:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Mon, Mar 17, 2025, 6:29 AM +0700" prefix="Updated " > Mar 17 <i class="unloaded">2025-03-17T06:29:35+07:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1654 words">9 min</span></div></div><div class="post-content"><p>Proxy chắc là khái niệm đã không còn xa lạ gì với tất cả mọi người. Với người làm về crawl dữ liệu thì proxy như vật bất ly thân. Trong bài viết này, mình sẽ hướng dẫn cách cấu hình proxy cho project Scrapy. Project mình sử dụng để làm ví dụ cho bài viết này là project crawl alonhadat <a href="https://github.com/demanejar/crawl-alonhadat">https://github.com/demanejar/crawl-alonhadat</a>.</p><blockquote><p>Với mỗi bài viết của mình như bài viết này là “Cấu hình proxy cho project Scrapy”, nhưng mình đang không muốn chỉ nói về cấu hình proxy trong project như nào, mình muốn nói rộng hơn ra một tí về những vấn đề liên quan. Nếu bạn quan tâm tới ý chính là cấu hình proxy cho project Scrapy như nào thì có thể bỏ qua phần dạo đầu này và kéo mạnh tay hơn một tí xuống tới đoạn sau của bài viết.</p></blockquote><h2 id="proxy-và-các-website-chặn-bot-dựa-trên-lưu-lượng-truy-cập-bất-thường">Proxy và các website chặn bot dựa trên lưu lượng truy cập bất thường</h2><p>Bài viết trước chúng ta đã đi phân tích website, viết chương trình để thu thập dữ liệu. Tuy nhiên thì như thế là chưa đủ, bây giờ thì alonhadat đã thực hiện ban các IP mà có lưu lượng truy cập nhiều trong khoảng thời gian nhất định. Dễ thấy nhất thì chỉ cần chạy project trên tầm 4-5 phút (hoặc ít hơn là 2-3 phút thôi) sẽ thấy sinh ra một tá exception và sau khi truy cập lại website alonhadat sẽ có kết quả:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/demanejar/image-collection/main/crawldataalonhadata/alonhadat_ban_bot.png" alt="" /></p><p>Với hình ảnh này có thể tạm dự đoán là alonhadat đang chặn bot theo IP, vì ngoài các bot bị bắt vươt capcha thì khi người dùng thật vào trang web cũng đang bị bắt vượt capcha. Cách này là một trong những cách đơn giản nhất để bảo vệ website khỏi các con bot crawl, cứ thấy IP nào có lưu lượng truy cập bất thường là ban luôn, 1-2 ngày sau hay 1-2 tháng sau thì lại bỏ, bất thường lai ban tiếp.</p><p>Với những website sử dụng cách ban này thì cơ bản sẽ có 2 cách để tránh:</p><ul><li><p>1 là dùng proxy, thật nhiều proxy. Phải tùy theo website chặn như nào, nếu như cái ngưỡng chặn của website là nhỏ (ngưỡng ở đây mình đang muốn nói tới là số lượt truy cập website trên một thời gian nhất định) thì chúng ta sẽ phải cần thật nhiều proxy, còn nếu ngưỡng này cao hơn thì chúng ta có thể sẽ cần ít proxy hơn. Còn việc cần bao nhiêu proxy là đủ thì phải qua thử nghiệm. Ví dụ như trước mình crawl website <a href="https://www.yelp.com/">https://www.yelp.com/</a>, mình sử dụng 1 pool có 10 proxy, mỗi request để cách nhau là 2s và mỗi request sẽ pick random 1 proxy để truy cập vào website thì sau 2-3 tiếng thì 10 proxy đã bị ban sạch, vì thế mình quyết định tăng lên 100, thời gian lần này lâu hơn là sau 1 đêm 100 proxy này cũng bị ban sạch, vấn đề là giờ cần nhiều proxy hơn nữa, 1000 thì sao? Và đấy mới dừng lại ở dự đoán thôi và vì 1000 proxy thì bao tiền cho đủ nên mình quyết định thôi</p><li><p>2 thì khó hơn đó là viết script để bypass capcha. Cách này không hẳn lúc nào cũng dùng được vì có một số website họ chặn luôn chứ không phải là bắt người dùng vượt capcha để tiếp tục xem nội dung, tiêu biểu như <a href="https://www.yelp.com/">https://www.yelp.com/</a> và website này tất nhiên là có ngưỡng chặn lớn hơn. Với việc các capcha này rất dễ thay đổi sang loại khác vì vậy các đoán script bạn viết cũng dùng được trong một thời gian khá ngắn, và hiện nay cũng có nhiều các loại capcha rất phức tạp, việc có thể bypass các loại capcha mới này nhìn chung là khó</p></ul><p>Với cách ban này cũng mang lại trải nghiệm khá tệ cho người dùng. Khi mình là người đi crawl thì alonhadat đang ban IP của mình và mình vào website đang phải vượt capcha, nhưng các bạn cùng phòng của mình dùng chung một wifi và có chung một IP cũng đang bị bắt vươt capcha như vậy mặc dù họ trả làm gì. Vì thế có thể là website đang sử dụng phương pháp này là tạm thời trong thời trong khi họ nghiên cứu để có phương án tốt hơn.</p><h2 id="data-flow-và-kiến-trúc-của-scrapy">Data Flow và kiến trúc của Scrapy</h2><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/demanejar/image-collection/main/scrapy/scrapy_structure.png" alt="" /></p><p>Scrapy sẽ gồm 6 thành phần:</p><ul><li><p>Scrapy Engine: chịu trách nhiệm trong việc điều khiển dòng dữ liệu di chuyển giữa các thành phần trong hệ thống, kích hoạt một số sự kiện trong một số điều kiện nhất định</p><li><p>Downloader: tìm và tải các đoạn mã HTML từ trang web được chỉ định</p><li><p>Spiders: là nơi chúng ta làm việc chủ yếu, nơi viết các đoạn mã để phân tích website</p><li><p>Item Pipeline: chịu trách nhiệm xử lý các Item được trích xuất và tạo bởi Spiders</p><li><p>Middleware: sẽ có 2 loại middleware, 1 là middleware nằm giữa Spiders và Engine, middleware này thường sẽ ít sử dụng hơn vì các đoạn mã được viết trong Spider Middleware cũng có thể thay thế bằng cách viết trong Spiders hoặc Item Pipeline. 2 là Downloader Middleware nằm giữa Downloader và Engine, nó nhằm mục đích xử lý các request trước khi chúng được đưa tới Downloader điển hình nhất như là thêm proxy vào các request</p></ul><p>Qua việc tìm hiểu về từng thành phần và chức năng của từng thành phần chắc mọi người đều đã hình dung ra chúng ta sẽ cấu hình proxy cho từng request trong Downloader Middleware.</p><h2 id="cấu-hình-proxy-cho-project-scrapy">Cấu hình proxy cho project Scrapy</h2><p>Nếu bạn chưa biết sử dụng proxy từ website nào thì có thể tham khảo website <a href="https://www.webshare.io/?referral_code=ttjajplnrle1">https://proxy.webshare.io/</a>, proxy trên website này rẻ mà cũng khá chất lượng, mỗi nick còn có 10 proxy free dùng để test.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/demanejar/image-collection/main/scrapy/proxy_webshareio.png" alt="" /></p><p>Vào mục <code class="language-plaintext highlighter-rouge">Proxy -&gt; List -&gt; Download</code> tải về list proxy, đổi tên file tải về thành proxies.txt và copy chúng vào thư mục project.</p><p>Trong file <code class="language-plaintext highlighter-rouge">middlewares.py</code> chính là nơi chứa các đoạn code của Spider Middleware và Downloader Middleware. Trong file có 2 class và các method được định nghĩa và comment rõ ràng cách sử dụng.</p><p>Để thêm proxy cho các request trước khi được gửi tới Downloader, chúng ta sẽ viết vào hàm <code class="language-plaintext highlighter-rouge">process_request</code> của class <code class="language-plaintext highlighter-rouge">DataPriceDownloaderMiddleware</code>:</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">w3lib.http</span> <span class="kn">import</span> <span class="n">basic_auth_header</span>
<span class="kn">import</span> <span class="n">random</span>

<span class="n">proxyPools</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="sh">"</span><span class="s">data_price/proxies.txt</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">).</span><span class="nf">read</span><span class="p">().</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">DataPriceDownloaderMiddleware</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="c1"># Not all methods need to be defined. If a method is not defined,
</span>    <span class="c1"># scrapy acts as if the downloader middleware does not modify the
</span>    <span class="c1"># passed objects.
</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_crawler</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">crawler</span><span class="p">):</span>
        <span class="c1"># This method is used by Scrapy to create your spiders.
</span>        <span class="n">s</span> <span class="o">=</span> <span class="nf">cls</span><span class="p">()</span>
        <span class="n">crawler</span><span class="p">.</span><span class="n">signals</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">spider_opened</span><span class="p">,</span> <span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="p">.</span><span class="n">spider_opened</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="k">def</span> <span class="nf">process_request</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">spider</span><span class="p">):</span>
        <span class="c1"># Called for each request that goes through the downloader
</span>        <span class="c1"># middleware.
</span>
        <span class="c1"># Must either:
</span>        <span class="c1"># - return None: continue processing this request
</span>        <span class="c1"># - or return a Response object
</span>        <span class="c1"># - or return a Request object
</span>        <span class="c1"># - or raise IgnoreRequest: process_exception() methods of
</span>        <span class="c1">#   installed downloader middleware will be called
</span>        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">process_response</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">spider</span><span class="p">):</span>
        <span class="c1"># Called with the response returned from the downloader.
</span>
        <span class="c1"># Must either;
</span>        <span class="c1"># - return a Response object
</span>        <span class="c1"># - return a Request object
</span>        <span class="c1"># - or raise IgnoreRequest
</span>
        <span class="n">proxy</span> <span class="o">=</span> <span class="n">random</span><span class="p">.</span><span class="nf">choice</span><span class="p">(</span><span class="n">proxyPools</span><span class="p">).</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">httpsProxy</span> <span class="o">=</span> <span class="n">proxy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">portProxy</span> <span class="o">=</span> <span class="n">proxy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">usernameProxy</span> <span class="o">=</span> <span class="n">proxy</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">passwordProxy</span> <span class="o">=</span> <span class="n">proxy</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

        <span class="n">request</span><span class="p">.</span><span class="n">meta</span><span class="p">[</span><span class="sh">'</span><span class="s">proxy</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">http://</span><span class="sh">"</span> <span class="o">+</span> <span class="n">httpsProxy</span> <span class="o">+</span> <span class="sh">"</span><span class="s">:</span><span class="sh">"</span> <span class="o">+</span> <span class="n">portProxy</span>
        <span class="n">request</span><span class="p">.</span><span class="n">headers</span><span class="p">[</span><span class="sh">'</span><span class="s">Proxy-Authorization</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="nf">basic_auth_header</span><span class="p">(</span><span class="n">usernameProxy</span><span class="p">,</span> <span class="n">passwordProxy</span><span class="p">)</span> 

        <span class="k">return</span> <span class="n">response</span>

    <span class="k">def</span> <span class="nf">process_exception</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">exception</span><span class="p">,</span> <span class="n">spider</span><span class="p">):</span>
        <span class="c1"># Called when a download handler or a process_request()
</span>        <span class="c1"># (from other downloader middleware) raises an exception.
</span>
        <span class="c1"># Must either:
</span>        <span class="c1"># - return None: continue processing this exception
</span>        <span class="c1"># - return a Response object: stops process_exception() chain
</span>        <span class="c1"># - return a Request object: stops process_exception() chain
</span>        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">spider_opened</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spider</span><span class="p">):</span>
        <span class="n">spider</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">'</span><span class="s">Spider opened: %s</span><span class="sh">'</span> <span class="o">%</span> <span class="n">spider</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
</pre></table></code></div></div><ul><li><p>Chúng ta định nghĩa trước một <code class="language-plaintext highlighter-rouge">proxyPools</code> đọc từ file <code class="language-plaintext highlighter-rouge">proxies.txt</code> vừa được thêm vào project</p><li><p>Trong <code class="language-plaintext highlighter-rouge">process_request</code> chúng ta sẽ pick random một proxy bất kì và add chúng vào headers</p></ul><p>Bây giờ vào file <code class="language-plaintext highlighter-rouge">settings.py</code> tìm tới vị trí <code class="language-plaintext highlighter-rouge">DOWNLOADER_MIDDLEWARES</code> và bỏ comment, sau đó thêm vào môt <code class="language-plaintext highlighter-rouge">HttpProxyMiddleware</code> nữa để các Middleware này được gọi tới khi bắt đầu crawl:</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">DOWNLOADER_MIDDLEWARES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">'</span><span class="s">scrapy.downloadermiddlewares.httpproxy.HttpProxyMiddleware</span><span class="sh">'</span><span class="p">:</span> <span class="mi">600</span><span class="p">,</span>  
    <span class="sh">'</span><span class="s">data_price.middlewares.DataPriceDownloaderMiddleware</span><span class="sh">'</span><span class="p">:</span> <span class="mi">543</span><span class="p">,</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Chuyển con số của <code class="language-plaintext highlighter-rouge">HttpProxyMiddleware</code> lớn hơn <code class="language-plaintext highlighter-rouge">DataPriceDownloaderMiddleware</code> để nó được gọi sau. Cái số <code class="language-plaintext highlighter-rouge">543</code> và <code class="language-plaintext highlighter-rouge">600</code> là độ ưu tiên để hệ thống biết cần gọi tới cái nào trước.</p><p>Giờ chạy lại project chúng ta sẽ lại thấy các kết quả lần lượt được trả về và vừa nãy còn bắn ra rất nhiều <code class="language-plaintext highlighter-rouge">exception</code> do các element không được tìm thấy:</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://raw.githubusercontent.com/demanejar/image-collection/main/crawldataalonhadata/proxy_alonhadat_1.png" alt="" /></p><p>Bạn có thể thêm một proxy pool với nhiều proxy hơn và để thêm thời gian delay trong <code class="language-plaintext highlighter-rouge">settings.py</code> tránh việc request được gửi quá nhanh và liên tục:</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">DOWNLOAD_DELAY</span> <span class="o">=</span> <span class="mi">2</span>
</pre></table></code></div></div><p>Xem chi tiết project tại: <a href="https://github.com/demanejar/crawl-alonhadat/blob/master/data_price/middlewares.py">https://github.com/demanejar/crawl-alonhadat</a></p><h2 id="sử-dụng-thư-viện-để-cấu-hình-proxy-cho-project-scrapy">Sử dụng thư viện để cấu hình proxy cho project Scrapy</h2><p>Thư viện mình nói tới ở đây là <a href="https://github.com/TeamHG-Memex/scrapy-rotating-proxies">Rotating proxies</a>.</p><p>Cài đặt Rotating proxies:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>pip <span class="nb">install </span>scrapy-rotating-proxies
</pre></table></code></div></div><p>Thêm biến <code class="language-plaintext highlighter-rouge">ROTATING_PROXY_LIST</code> vào file <code class="language-plaintext highlighter-rouge">settings.py</code>:</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">ROTATING_PROXY_LIST</span> <span class="o">=</span> <span class="p">[</span>
  <span class="sh">'</span><span class="s">host1:port1</span><span class="sh">'</span><span class="p">,</span>
  <span class="sh">'</span><span class="s">host2:port2</span><span class="sh">'</span><span class="p">,</span>
<span class="p">]</span>
</pre></table></code></div></div><p>Hoặc sử dụng <code class="language-plaintext highlighter-rouge">ROTATING_PROXY_LIST_PATH</code> để cấu hình tới file proxies:</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">ROTATING_PROXY_LIST_PATH</span> <span class="o">=</span> <span class="sh">'</span><span class="s">/my/path/proxies.txt</span><span class="sh">'</span>
</pre></table></code></div></div><p>Xem docs chi tiết của thư viện này tại <a href="https://github.com/TeamHG-Memex/scrapy-rotating-proxies">https://github.com/TeamHG-Memex/scrapy-rotating-proxies</a>.</p><p>Vì website không có mục bình luận dưới bài viết nên mọi người thảo luận và góp ý cho mình tại GITHUB DISCUSSION này nha: <a href="https://github.com/orgs/demanejar/discussions/1">https://github.com/orgs/demanejar/discussions/1</a>.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/crawler/'>Crawler</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/crawler/" class="post-tag no-text-decoration" >Crawler</a> <a href="/tags/scrapy/" class="post-tag no-text-decoration" >Scrapy</a> <a href="/tags/alonhadat/" class="post-tag no-text-decoration" >alonhadat</a> <a href="/tags/proxy/" class="post-tag no-text-decoration" >proxy</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Cấu hình proxy cho project Scrapy - De Manejar&url=https://demanejar.github.io/posts/add-proxy-to-scrapy-project/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Cấu hình proxy cho project Scrapy - De Manejar&u=https://demanejar.github.io/posts/add-proxy-to-scrapy-project/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Cấu hình proxy cho project Scrapy - De Manejar&url=https://demanejar.github.io/posts/add-proxy-to-scrapy-project/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/k8s/">Tìm hiểu tổng quan k8s</a><li><a href="/posts/add-proxy-to-scrapy-project/">Cấu hình proxy cho project Scrapy</a><li><a href="/posts/crawl-1000-website-new-with-scrapy/">Crawl 1000 trang báo với Scrapy và MySQL</a><li><a href="/posts/php-scraper/">PHP Scraper</a><li><a href="/posts/scrapy-shell/">Giới thiệu Scrapy Shell</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/bigdata/">Bigdata</a> <a class="post-tag" href="/tags/spark/">Spark</a> <a class="post-tag" href="/tags/crawler/">Crawler</a> <a class="post-tag" href="/tags/hdfs/">HDFS</a> <a class="post-tag" href="/tags/scrapy/">Scrapy</a> <a class="post-tag" href="/tags/hadoop/">Hadoop</a> <a class="post-tag" href="/tags/apache-hadoop/">Apache Hadoop</a> <a class="post-tag" href="/tags/ubuntu/">Ubuntu</a> <a class="post-tag" href="/tags/spark-sql/">Spark SQL</a> <a class="post-tag" href="/tags/alonhadat/">alonhadat</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/crawl-1000-website-new-with-scrapy/"><div class="card-body"> <span class="timeago small" > Mar 1, 2023 <i class="unloaded">2023-03-01T20:52:00+07:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Crawl 1000 trang báo với Scrapy và MySQL</h3><div class="text-muted small"><p> Nếu với mỗi website lại viết 1 spider để phân tích thông tin thì sẽ rất mất thời gian, nhất là với các website tin tức, có hàng ngàn các website tin tức khác nhau và chúng còn mọc ra mỗi ngày. Vậy...</p></div></div></a></div><div class="card"> <a href="/posts/crawl-housing-data-from-alonhadat/"><div class="card-body"> <span class="timeago small" > Jan 24, 2023 <i class="unloaded">2023-01-24T20:52:00+07:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Crawl dữ liệu nhà đất từ alonhadat với Scrapy</h3><div class="text-muted small"><p> Trong bài viết này mình sẽ giới thiệu chi tiết về cách tạo một project với Scrapy và sử dụng để phân tích lấy dữ liệu nhà đất từ trang alonhadat. Nếu máy bạn chưa có Scrapy thì có thể cài đặt bằng...</p></div></div></a></div><div class="card"> <a href="/posts/scrapy-shell/"><div class="card-body"> <span class="timeago small" > Apr 1, 2023 <i class="unloaded">2023-04-01T20:52:00+07:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Giới thiệu Scrapy Shell</h3><div class="text-muted small"><p> Mỗi lần viết 1 spider chúng ta phải viết nhiều các đoạn css selector, xpath để phân tích thông tin mà nhiều lúc không biết nó đúng hay sai. Mỗi lần như vậy thì lại phải chạy project rồi in ra thông...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/crawl-housing-data-from-alonhadat/" class="btn btn-outline-primary" prompt="Older"><p>Crawl dữ liệu nhà đất từ alonhadat với Scrapy</p></a> <a href="/posts/crawl-1000-website-new-with-scrapy/" class="btn btn-outline-primary" prompt="Newer"><p>Crawl 1000 trang báo với Scrapy và MySQL</p></a></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('.post-content img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://twitter.com/DeManejar">demanejar</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div></div><script type="text/javascript"> var links = document.links; for (var i = 0, linksLength = links.length; i < linksLength; i++) { if (links[i].hostname != window.location.hostname) { links[i].target = '_blank'; } } </script></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/bigdata/">Bigdata</a> <a class="post-tag" href="/tags/spark/">Spark</a> <a class="post-tag" href="/tags/crawler/">Crawler</a> <a class="post-tag" href="/tags/hdfs/">HDFS</a> <a class="post-tag" href="/tags/scrapy/">Scrapy</a> <a class="post-tag" href="/tags/hadoop/">Hadoop</a> <a class="post-tag" href="/tags/apache-hadoop/">Apache Hadoop</a> <a class="post-tag" href="/tags/ubuntu/">Ubuntu</a> <a class="post-tag" href="/tags/spark-sql/">Spark SQL</a> <a class="post-tag" href="/tags/alonhadat/">alonhadat</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js"></script> <script> $(function() { let initTheme = "default"; if ($("html[mode=dark]").length > 0 || ($("html[mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches ) ) { initTheme = "dark"; } let mermaidConf = { theme: initTheme /* <default|dark|forest|neutral> */ }; /* Markdown converts to HTML */ $("pre").has("code.language-mermaid").each(function() { let svgCode = $(this).children().html(); $(this).addClass("unloaded"); $(this).after(`<div class=\"mermaid\">${svgCode}</div>`); }); mermaid.initialize(mermaidConf); }); </script><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://demanejar.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
