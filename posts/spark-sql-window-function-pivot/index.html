<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta property="og:image" content="https://raw.githubusercontent.com/demanejar/image-collection/refs/heads/main/SparkWindowFunction/cc38cddba42b235e5e23638e9473b7d8.jpg"> <script async src="https://www.googletagmanager.com/gtag/js?id=G-9TR0K3B846"></script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8714452693053438" crossorigin="anonymous"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-9TR0K3B846'); </script><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="Window function, pivot trong Spark SQL" /><meta name="author" content="trannguyenhan" /><meta property="og:locale" content="en_US" /><meta name="description" content="Window aggregate functions (hay thường được gọi tắt là window functions hoặc windowed aggregates) là hàm giúp hỗ trợ tính toán trên 1 nhóm các bản ghi được gọi là cửa sổ mà có liên quan tới bản ghi hiện tại." /><meta property="og:description" content="Window aggregate functions (hay thường được gọi tắt là window functions hoặc windowed aggregates) là hàm giúp hỗ trợ tính toán trên 1 nhóm các bản ghi được gọi là cửa sổ mà có liên quan tới bản ghi hiện tại." /><link rel="canonical" href="https://demanejar.github.io/posts/spark-sql-window-function-pivot/" /><meta property="og:url" content="https://demanejar.github.io/posts/spark-sql-window-function-pivot/" /><meta property="og:site_name" content="De Manejar" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-09-09T08:52:00+07:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Window function, pivot trong Spark SQL" /><meta name="twitter:site" content="@DeManejar" /><meta name="twitter:creator" content="@trannguyenhan" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"trannguyenhan"},"dateModified":"2025-03-17T06:29:35+07:00","datePublished":"2021-09-09T08:52:00+07:00","description":"Window aggregate functions (hay thường được gọi tắt là window functions hoặc windowed aggregates) là hàm giúp hỗ trợ tính toán trên 1 nhóm các bản ghi được gọi là cửa sổ mà có liên quan tới bản ghi hiện tại.","headline":"Window function, pivot trong Spark SQL","mainEntityOfPage":{"@type":"WebPage","@id":"https://demanejar.github.io/posts/spark-sql-window-function-pivot/"},"url":"https://demanejar.github.io/posts/spark-sql-window-function-pivot/"}</script><title>Window function, pivot trong Spark SQL | De Manejar</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script> /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */ MathJax = { tex: { inlineMath: [ /* start/end delimiter pairs for in-line math */ ['$','$'], ['\\(','\\)'] ], displayMath: [ /* start/end delimiter pairs for display math */ ['$$', '$$'], ['\\[', '\\]'] ] } }; </script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"> </script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://i.pinimg.com/564x/9c/32/79/9c3279b5ac960533cbcb7e833ac4d947.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">De Manejar</a></div><div class="site-subtitle font-italic">Hello Bigdata !</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/demanejar" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/DeManejar" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['demanejar','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Window function, pivot trong Spark SQL</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Window function, pivot trong Spark SQL</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> trannguyenhan </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Thu, Sep 9, 2021, 8:52 AM +0700" prep="on" > Sep 9, 2021 <i class="unloaded">2021-09-09T08:52:00+07:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Mon, Mar 17, 2025, 6:29 AM +0700" prefix="Updated " > Mar 17 <i class="unloaded">2025-03-17T06:29:35+07:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1414 words">7 min</span></div></div><div class="post-content"><p><em>Window aggregate functions (hay thường được gọi tắt là window functions hoặc windowed aggregates) là hàm giúp hỗ trợ tính toán trên 1 nhóm các bản ghi được gọi là cửa sổ mà có liên quan tới bản ghi hiện tại.</em></p><p>Nhìn chung thì những phần này khá trìu tượng về mặt lý thuyết nên đọc lý thuyết càng gây ra các cảm giác khó hiểu nên thế mình sẽ giới thiệu <em>window function</em> và <em>pivot</em> qua những ví dụ để dễ dàng hình dung hơn nha.</p><h2 id="example-1-simple-select">Example 1: Simple select</h2><h3 id="yêu-cầu">Yêu cầu</h3><p>Cho tập dữ liệu dưới dạng file csv như sau với tên file là <code class="language-plaintext highlighter-rouge">input.csv</code>:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>id,name,population
0,Warsaw,1 764 615
1,Villeneuve-Loubet,15 020
2,Vranje,83 524
3,Pittsburgh,1 775 634
</pre></table></code></div></div><ul><li>Load dữ liệu từ csv file<li>Query population lớn nhất</ul><p>INPUT:</p><div class="table-wrapper"><table><thead><tr><th>id<th>name<th>population<tbody><tr><td>0<td>Warsaw<td>1 764 615<tr><td>1<td>Villeneuve-Loubet<td>15 020<tr><td>2<td>Vranje<td>83 524<tr><td>3<td>Pittsburgh<td>1 775 634</table></div><p>OUTPUT:</p><div class="table-wrapper"><table><thead><tr><th>population<tbody><tr><td>1775634</table></div><h3 id="lời-giải">Lời giải</h3><p>Bài này mang tính chất khởi động thôi chứ chưa hề động gì tới <em>window function</em> hay <em>pivot</em> cả, mọi người làm như bình thường:</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">part1</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.spark.sql.Dataset</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.Row</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.SparkSession</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">SparkSession</span> <span class="n">spark</span> <span class="o">=</span> <span class="nc">SparkSession</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">appName</span><span class="o">(</span><span class="s">"Bai_1"</span><span class="o">).</span><span class="na">master</span><span class="o">(</span><span class="s">"local"</span><span class="o">).</span><span class="na">getOrCreate</span><span class="o">();</span>
		<span class="nc">Dataset</span><span class="o">&lt;</span><span class="nc">Row</span><span class="o">&gt;</span> <span class="n">data</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="na">read</span><span class="o">().</span><span class="na">option</span><span class="o">(</span><span class="s">"header"</span><span class="o">,</span> <span class="kc">true</span><span class="o">).</span><span class="na">option</span><span class="o">(</span><span class="s">"inferSchema"</span><span class="o">,</span> <span class="kc">true</span><span class="o">).</span><span class="na">csv</span><span class="o">(</span><span class="s">"src/part1/input.csv"</span><span class="o">);</span>
		
		<span class="n">data</span><span class="o">.</span><span class="na">createOrReplaceTempView</span><span class="o">(</span><span class="s">"data"</span><span class="o">);</span>
		<span class="nc">Dataset</span><span class="o">&lt;</span><span class="nc">Row</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">(</span><span class="s">"select population from data order by population desc limit 1"</span><span class="o">);</span>
		
		
		<span class="n">result</span><span class="o">.</span><span class="na">show</span><span class="o">();</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><ul><li><em>option</em> <em>header</em> giúp việc đọc vào từ file csv sẽ mặc định dòng đầu tiên là dòng tiêu đề cho các hàng<li><em>option</em> <em>inferSchema</em> sẽ mặc định cho Spark tự nhận dạng dữ liệu đầu vào mà không cần chúng ta phải tạo <em>schema</em> nữa</ul><p>Chúng ta sẽ được kết quả của bài 1 như sau:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>+----------+
|population|
+----------+
|   1775634|
+----------+
</pre></table></code></div></div><h2 id="example-2-group-function">Example 2: group function</h2><h3 id="yêu-cầu-1">Yêu cầu</h3><p>Cho tập dữ liệu sau:</p><div class="table-wrapper"><table><thead><tr><th>id<th>group<tbody><tr><td>0<td>0<tr><td>1<td>1<tr><td>2<td>0<tr><td>3<td>1<tr><td>4<td>0</table></div><p>Nhóm lại các <em>id</em> cùng <em>group</em> và cho ra output như sau:</p><div class="table-wrapper"><table><thead><tr><th>group<th>ids<tbody><tr><td>0<td>[0, 2, 4]<tr><td>1<td>[1, 3]</table></div><p>Lưu ý: [0,2,4] là biểu diễn mảng</p><h3 id="lời-giải-1">Lời giải</h3><p>Bài này cũng chưa phải <em>window function</em> hay <em>pivot</em> gì, chúng ta nhóm bằng việc sử dụng hàm <em>group</em> như sau:</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">part2</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.spark.sql.Dataset</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.Row</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.RowFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.SparkSession</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.functions</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.types.StructType</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">SparkSession</span> <span class="n">spark</span> <span class="o">=</span> <span class="nc">SparkSession</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">appName</span><span class="o">(</span><span class="s">"Bai_1"</span><span class="o">).</span><span class="na">master</span><span class="o">(</span><span class="s">"local"</span><span class="o">).</span><span class="na">getOrCreate</span><span class="o">();</span>
		
		<span class="nc">StructType</span> <span class="n">schema</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StructType</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="s">"id"</span><span class="o">,</span> <span class="s">"integer"</span><span class="o">)</span>
				<span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"group"</span><span class="o">,</span> <span class="s">"integer"</span><span class="o">);</span>

        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Row</span><span class="o">&gt;</span> <span class="n">listOfdata</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">Row</span><span class="o">&gt;();</span>
        <span class="n">listOfdata</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">RowFactory</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">));</span>
        <span class="n">listOfdata</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">RowFactory</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">1</span><span class="o">));</span>
        <span class="n">listOfdata</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">RowFactory</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span><span class="mi">0</span><span class="o">));</span>
        <span class="n">listOfdata</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">RowFactory</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span><span class="mi">1</span><span class="o">));</span>
        <span class="n">listOfdata</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">RowFactory</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="mi">4</span><span class="o">,</span><span class="mi">0</span><span class="o">));</span>
        
        <span class="nc">Dataset</span><span class="o">&lt;</span><span class="nc">Row</span><span class="o">&gt;</span> <span class="n">data</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="na">createDataFrame</span><span class="o">(</span><span class="n">listOfdata</span><span class="o">,</span><span class="n">schema</span><span class="o">);</span>
        
        <span class="nc">Dataset</span><span class="o">&lt;</span><span class="nc">Row</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="na">groupBy</span><span class="o">(</span><span class="s">"group"</span><span class="o">)</span>
        		<span class="o">.</span><span class="na">agg</span><span class="o">(</span><span class="n">functions</span><span class="o">.</span><span class="na">collect_list</span><span class="o">(</span><span class="s">"id"</span><span class="o">).</span><span class="na">as</span><span class="o">(</span><span class="s">"ids"</span><span class="o">)).</span><span class="na">sort</span><span class="o">(</span><span class="s">"group"</span><span class="o">);</span>
        
        <span class="n">result</span><span class="o">.</span><span class="na">show</span><span class="o">();</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>Chúng ta sẽ được kết quả của bài 2 như sau:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>+-----+---------+
|group|      ids|
+-----+---------+
|    0|[0, 2, 4]|
|    1|   <span class="o">[</span>1, 3]|
+-----+---------+
</pre></table></code></div></div><h2 id="example-3-pivot">Example 3: pivot</h2><h3 id="yêu-cầu-2">Yêu cầu</h3><p>Cho tập dữ liệu như sau:</p><div class="table-wrapper"><table><thead><tr><th>id<th>day<th>price<th>units<tbody><tr><td>100<td>1<td>23<td>10<tr><td>100<td>2<td>45<td>11<tr><td>100<td>3<td>67<td>12<tr><td>100<td>4<td>78<td>13<tr><td>101<td>1<td>23<td>10<tr><td>101<td>2<td>45<td>13<tr><td>101<td>3<td>67<td>14<tr><td>101<td>4<td>78<td>15<tr><td>102<td>1<td>23<td>10<tr><td>102<td>2<td>45<td>11<tr><td>102<td>3<td>67<td>16<tr><td>102<td>4<td>78<td>18</table></div><p>Sử dụng <em>pivot</em> và cho ra kết quả như sau:</p><div class="table-wrapper"><table><thead><tr><th>id<th>price_1<th>price_2<th>price_3<th>price_4<th>unit_1<th>unit_2<th>unit_3<th>unit_4<tbody><tr><td>100<td>23<td>45<td>67<td>78<td>10<td>11<td>12<td>13<tr><td>101<td>23<td>45<td>67<td>78<td>10<td>13<td>14<td>15<tr><td>102<td>23<td>45<td>67<td>78<td>10<td>11<td>16<td>18</table></div><h3 id="lời-giải-2">Lời giải</h3><p>Đầu tiên là chúng ta sẽ đi tạo tập dữ liệu theo yêu cầu đề bài (các bạn cũng có thể tạo 1 file csv và đọc vào cũng được nha, ở đây mình muốn tạo dữ liệu bởi nhiều cách để có thể giới thiệu hết 1 lượt những cách tạo dữ liệu input trong <em>spark</em>):</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="nc">StructType</span> <span class="n">schema</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StructType</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="s">"id"</span><span class="o">,</span> <span class="s">"integer"</span><span class="o">)</span>
				<span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"day"</span><span class="o">,</span> <span class="s">"integer"</span><span class="o">)</span>
				<span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"price"</span><span class="o">,</span> <span class="s">"integer"</span><span class="o">)</span>
				<span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"units"</span><span class="o">,</span> <span class="s">"integer"</span><span class="o">);</span>

<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Row</span><span class="o">&gt;</span> <span class="n">listOfdata</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">Row</span><span class="o">&gt;();</span>
<span class="n">listOfdata</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">RowFactory</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="mi">100</span><span class="o">,</span><span class="mi">1</span><span class="o">,</span><span class="mi">23</span><span class="o">,</span><span class="mi">10</span><span class="o">));</span>
<span class="n">listOfdata</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">RowFactory</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="mi">100</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mi">45</span><span class="o">,</span><span class="mi">11</span><span class="o">));</span>
<span class="n">listOfdata</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">RowFactory</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="mi">100</span><span class="o">,</span><span class="mi">3</span><span class="o">,</span><span class="mi">67</span><span class="o">,</span><span class="mi">12</span><span class="o">));</span>
<span class="n">listOfdata</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">RowFactory</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="mi">100</span><span class="o">,</span><span class="mi">4</span><span class="o">,</span><span class="mi">78</span><span class="o">,</span><span class="mi">13</span><span class="o">));</span>
<span class="n">listOfdata</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">RowFactory</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="mi">101</span><span class="o">,</span><span class="mi">1</span><span class="o">,</span><span class="mi">23</span><span class="o">,</span><span class="mi">10</span><span class="o">));</span>
<span class="n">listOfdata</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">RowFactory</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="mi">101</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mi">45</span><span class="o">,</span><span class="mi">13</span><span class="o">));</span>
<span class="n">listOfdata</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">RowFactory</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="mi">101</span><span class="o">,</span><span class="mi">3</span><span class="o">,</span><span class="mi">67</span><span class="o">,</span><span class="mi">14</span><span class="o">));</span>
<span class="n">listOfdata</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">RowFactory</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="mi">101</span><span class="o">,</span><span class="mi">4</span><span class="o">,</span><span class="mi">78</span><span class="o">,</span><span class="mi">15</span><span class="o">));</span>
<span class="n">listOfdata</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">RowFactory</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="mi">102</span><span class="o">,</span><span class="mi">1</span><span class="o">,</span><span class="mi">23</span><span class="o">,</span><span class="mi">10</span><span class="o">));</span>
<span class="n">listOfdata</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">RowFactory</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="mi">102</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mi">45</span><span class="o">,</span><span class="mi">11</span><span class="o">));</span>
<span class="n">listOfdata</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">RowFactory</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="mi">102</span><span class="o">,</span><span class="mi">3</span><span class="o">,</span><span class="mi">67</span><span class="o">,</span><span class="mi">16</span><span class="o">));</span>
<span class="n">listOfdata</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">RowFactory</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="mi">102</span><span class="o">,</span><span class="mi">4</span><span class="o">,</span><span class="mi">78</span><span class="o">,</span><span class="mi">18</span><span class="o">));</span>
</pre></table></code></div></div><p>Nhìn vào yêu cầu output chúng ta sẽ thấy là sẽ có 2 yêu cầu rõ rệt là sẽ xoay ngang cột <em>price</em> và cột <em>unit</em>. Vậy chúng ta cũng sẽ làm từng bước một, <strong><em>đầu tiên</em></strong> là xoay ngang cột <em>price</em> ra trước như sau:</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nc">Dataset</span><span class="o">&lt;</span><span class="nc">Row</span><span class="o">&gt;</span> <span class="n">result_1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="na">withColumn</span><span class="o">(</span><span class="s">"concat_day"</span><span class="o">,</span> <span class="n">functions</span><span class="o">.</span><span class="na">concat</span><span class="o">(</span><span class="n">functions</span><span class="o">.</span><span class="na">lit</span><span class="o">(</span><span class="s">"price_"</span><span class="o">),</span> <span class="n">data</span><span class="o">.</span><span class="na">col</span><span class="o">(</span><span class="s">"day"</span><span class="o">)))</span>
				<span class="o">.</span><span class="na">groupBy</span><span class="o">(</span><span class="s">"id"</span><span class="o">).</span><span class="na">pivot</span><span class="o">(</span><span class="s">"concat_day"</span><span class="o">).</span><span class="na">agg</span><span class="o">(</span><span class="n">functions</span><span class="o">.</span><span class="na">first</span><span class="o">(</span><span class="s">"price"</span><span class="o">));</span>
</pre></table></code></div></div><ul><li><code class="language-plaintext highlighter-rouge">functions.concat()</code> giúp tạo ra các giá trị cho cột mới là <em>price</em> cộng với đuôi là giá trị <em>day</em><li><code class="language-plaintext highlighter-rouge">pivot</code> giúp xoay ngang lại bảng dữ liệu ban đầu với cột xoay là cột vừa mới tạo <em>concat_day</em></ul><p>Kết quả của bước đầu tiên sẽ là:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>+---+-------+-------+-------+-------+
| <span class="nb">id</span>|price_1|price_2|price_3|price_4|
+---+-------+-------+-------+-------+
|101|     23|     45|     67|     78|
|100|     23|     45|     67|     78|
|102|     23|     45|     67|     78|
+---+-------+-------+-------+-------+
</pre></table></code></div></div><p>Tương tự ta xoay ngang dữ liệu ban đầu theo cột <em>unit</em> ở <strong><em>bước 2</em></strong> như sau:</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nc">Dataset</span><span class="o">&lt;</span><span class="nc">Row</span><span class="o">&gt;</span> <span class="n">result_2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="na">withColumn</span><span class="o">(</span><span class="s">"concat_day"</span><span class="o">,</span> <span class="n">functions</span><span class="o">.</span><span class="na">concat</span><span class="o">(</span><span class="n">functions</span><span class="o">.</span><span class="na">lit</span><span class="o">(</span><span class="s">"unit_"</span><span class="o">),</span> <span class="n">data</span><span class="o">.</span><span class="na">col</span><span class="o">(</span><span class="s">"day"</span><span class="o">)))</span>
				<span class="o">.</span><span class="na">groupBy</span><span class="o">(</span><span class="s">"id"</span><span class="o">).</span><span class="na">pivot</span><span class="o">(</span><span class="s">"concat_day"</span><span class="o">).</span><span class="na">agg</span><span class="o">(</span><span class="n">functions</span><span class="o">.</span><span class="na">first</span><span class="o">(</span><span class="s">"units"</span><span class="o">));</span>
</pre></table></code></div></div><p>Kết quả của bước 2 là:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>+---+------+------+------+------+
| <span class="nb">id</span>|unit_1|unit_2|unit_3|unit_4|
+---+------+------+------+------+
|101|    10|    13|    14|    15|
|100|    10|    11|    12|    13|
|102|    10|    11|    16|    18|
+---+------+------+------+------+
</pre></table></code></div></div><p>Công việc <strong><em>còn lại</em></strong> là đơn giản rồi, chỉ cần nối 2 bảng lại là xong:</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nc">Dataset</span><span class="o">&lt;</span><span class="nc">Row</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">result_1</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="n">result_2</span><span class="o">,</span> <span class="s">"id"</span><span class="o">).</span><span class="na">sort</span><span class="o">(</span><span class="s">"id"</span><span class="o">);</span>
</pre></table></code></div></div><p>Ta sẽ có kết quả cuối cùng là:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>+---+-------+-------+-------+-------+------+------+------+------+
| <span class="nb">id</span>|price_1|price_2|price_3|price_4|unit_1|unit_2|unit_3|unit_4|
+---+-------+-------+-------+-------+------+------+------+------+
|100|     23|     45|     67|     78|    10|    11|    12|    13|
|101|     23|     45|     67|     78|    10|    13|    14|    15|
|102|     23|     45|     67|     78|    10|    11|    16|    18|
+---+-------+-------+-------+-------+------+------+------+------+
</pre></table></code></div></div><h2 id="example-4-window-function">Example 4: window function</h2><h3 id="yêu-cầu-3">Yêu cầu</h3><p>Cho tập dữ liệu sau:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="nb">time</span>,department,items_sold
1,IT,15
2,Support,81
3,Support,90
4,Support,25
5,IT,40
6,IT,24
7,Support,31
8,Support,1
9,HR,27
10,IT,75
</pre></table></code></div></div><p>Yêu cầu:</p><ul><li>Load dữ liệu vào spark từ file csv<li>Tính running_total hay <strong><em>tổng tích lũy</em></strong> số item đã bán được đến thời điểm time</ul><p>Output có dạng như sau:</p><div class="table-wrapper"><table><thead><tr><th>time<th>department<th>items_sold<th>running_total<tbody><tr><td>9<td>HR<td>27<td>27<tr><td>1<td>IT<td>15<td>15<tr><td>5<td>IT<td>40<td>55<tr><td>6<td>IT<td>24<td>79<tr><td>10<td>IT<td>75<td>154<tr><td>2<td>Support<td>81<td>81<tr><td>3<td>Support<td>90<td>171<tr><td>4<td>Support<td>25<td>196<tr><td>7<td>Support<td>31<td>227<tr><td>8<td>Support<td>1<td>228</table></div><h3 id="lời-giải-3">Lời giải</h3><p>Phân tích output tí ta có thể thấy:</p><ul><li>Các bản ghi được nhóm lại theo từng <em>department</em> và sắp xếp theo <em>time</em><li>Cột <em>running_total</em> được tính bằng tổng tích lũy các <em>items_sold</em> ở phía trước nó mà cùng <em>department</em></ul><p>Phần nhóm và sắp xếp thì ta có thể sử dụng <em>group</em> và <em>sort</em>, còn phần tính tổng tích lũy thì sao? Giờ phải có cách nào lấy ra các bản ghi cùng <em>department</em> và ở phía trước của bản ghi hiện tại, <em>window function</em> là cách tốt nhất để giải quyết vấn đề này.</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">part4</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.spark.sql.Dataset</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.Row</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.SparkSession</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.functions</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.expressions.Window</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.expressions.WindowSpec</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">SparkSession</span> <span class="n">spark</span> <span class="o">=</span> <span class="nc">SparkSession</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">appName</span><span class="o">(</span><span class="s">"Bai_4"</span><span class="o">).</span><span class="na">master</span><span class="o">(</span><span class="s">"local"</span><span class="o">).</span><span class="na">getOrCreate</span><span class="o">();</span>
		<span class="nc">Dataset</span><span class="o">&lt;</span><span class="nc">Row</span><span class="o">&gt;</span> <span class="n">data</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="na">read</span><span class="o">().</span><span class="na">option</span><span class="o">(</span><span class="s">"header"</span><span class="o">,</span> <span class="kc">true</span><span class="o">).</span><span class="na">option</span><span class="o">(</span><span class="s">"inferSchema"</span><span class="o">,</span> <span class="kc">true</span><span class="o">).</span><span class="na">csv</span><span class="o">(</span><span class="s">"src/part4/input.csv"</span><span class="o">);</span>
				
		<span class="nc">WindowSpec</span> <span class="n">wins</span> <span class="o">=</span> <span class="nc">Window</span><span class="o">.</span><span class="na">partitionBy</span><span class="o">(</span><span class="s">"department"</span><span class="o">).</span><span class="na">orderBy</span><span class="o">(</span><span class="s">"time"</span><span class="o">).</span><span class="na">rowsBetween</span><span class="o">(</span><span class="nc">Window</span><span class="o">.</span><span class="na">unboundedPreceding</span><span class="o">(),</span> <span class="nc">Window</span><span class="o">.</span><span class="na">currentRow</span><span class="o">());</span>
		<span class="nc">Dataset</span><span class="o">&lt;</span><span class="nc">Row</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="na">withColumn</span><span class="o">(</span><span class="s">"running_total"</span><span class="o">,</span> <span class="n">functions</span><span class="o">.</span><span class="na">sum</span><span class="o">(</span><span class="s">"items_sold"</span><span class="o">).</span><span class="na">over</span><span class="o">(</span><span class="n">wins</span><span class="o">));</span>
		
		<span class="n">result</span><span class="o">.</span><span class="na">show</span><span class="o">();</span>
	<span class="o">}</span>
<span class="o">}</span>

</pre></table></code></div></div><ul><li><code class="language-plaintext highlighter-rouge">partitionBy</code> chia tách dữ liệu ban đầu ra theo <em>partition</em><li><code class="language-plaintext highlighter-rouge">rowsBetween(Window.unboundedPreceding(), Window.currentRow())</code> giới hạn lại không gian của cửa sổ là từ đầu cho tới vị trí hiện tại<li><code class="language-plaintext highlighter-rouge">functions.sum("items_sold").over(wins)</code> là giá trị của cột <code class="language-plaintext highlighter-rouge">running_total</code> được tạo bằng tổng của cột <em>items_sold</em> giới hạn trong cửa sổ <code class="language-plaintext highlighter-rouge">wins</code></ul><p>Kết quả cuối cùng của ví dụ 4 sẽ là:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre>+----+----------+----------+-------------+
|time|department|items_sold|running_total|
+----+----------+----------+-------------+
|   9|        HR|        27|           27|
|   1|        IT|        15|           15|
|   5|        IT|        40|           55|
|   6|        IT|        24|           79|
|  10|        IT|        75|          154|
|   2|   Support|        81|           81|
|   3|   Support|        90|          171|
|   4|   Support|        25|          196|
|   7|   Support|        31|          227|
|   8|   Support|         1|          228|
+----+----------+----------+-------------+
</pre></table></code></div></div><p>Còn 1 số ví dụ nữa có lẽ mình sẽ viết trong phần 2 nha vì bài này cũng khá là dài rồi. Xem tiếp phần 2 <a href="https://demanejar.github.io/posts/spark-sql-window-function-pivot-part-2/">TẠI ĐÂY</a></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/hadoop-spark/'>Hadoop & Spark</a>, <a href='/categories/spark/'>Spark</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/spark-sql/" class="post-tag no-text-decoration" >Spark SQL</a> <a href="/tags/bigdata/" class="post-tag no-text-decoration" >Bigdata</a> <a href="/tags/spark/" class="post-tag no-text-decoration" >Spark</a> <a href="/tags/pivot-spark/" class="post-tag no-text-decoration" >pivot spark</a> <a href="/tags/window-function/" class="post-tag no-text-decoration" >window function</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Window function, pivot trong Spark SQL - De Manejar&url=https://demanejar.github.io/posts/spark-sql-window-function-pivot/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Window function, pivot trong Spark SQL - De Manejar&u=https://demanejar.github.io/posts/spark-sql-window-function-pivot/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Window function, pivot trong Spark SQL - De Manejar&url=https://demanejar.github.io/posts/spark-sql-window-function-pivot/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/k8s/">Tìm hiểu tổng quan k8s</a><li><a href="/posts/add-proxy-to-scrapy-project/">Cấu hình proxy cho project Scrapy</a><li><a href="/posts/crawl-1000-website-new-with-scrapy/">Crawl 1000 trang báo với Scrapy và MySQL</a><li><a href="/posts/php-scraper/">PHP Scraper</a><li><a href="/posts/scrapy-shell/">Giới thiệu Scrapy Shell</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/bigdata/">Bigdata</a> <a class="post-tag" href="/tags/spark/">Spark</a> <a class="post-tag" href="/tags/crawler/">Crawler</a> <a class="post-tag" href="/tags/hdfs/">HDFS</a> <a class="post-tag" href="/tags/scrapy/">Scrapy</a> <a class="post-tag" href="/tags/hadoop/">Hadoop</a> <a class="post-tag" href="/tags/apache-hadoop/">Apache Hadoop</a> <a class="post-tag" href="/tags/ubuntu/">Ubuntu</a> <a class="post-tag" href="/tags/spark-sql/">Spark SQL</a> <a class="post-tag" href="/tags/alonhadat/">alonhadat</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/spark-sql-window-function-pivot-part-2/"><div class="card-body"> <span class="timeago small" > Sep 14, 2021 <i class="unloaded">2021-09-14T08:52:00+07:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Window function, pivot trong Spark SQL (Part 2)</h3><div class="text-muted small"><p> Nếu bạn chưa xem phần 1 thì có thể xem lại TẠI ĐÂY nha, bài viết hôm nay mình sẽ giới thiệu tiếp tới mọi người một số ví dụ về window function và pivot sâu hơn để mọi người có thể hiểu rõ hơn về wi...</p></div></div></a></div><div class="card"> <a href="/posts/spark-sql-dataframe-dataset/"><div class="card-body"> <span class="timeago small" > Aug 26, 2021 <i class="unloaded">2021-08-26T20:52:00+07:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Spark SQL, Dataframe và Dataset</h3><div class="text-muted small"><p> Spark SQL là một mô hình để xử lý dữ liệu có cấu trúc của Spark rất phổ biến. Interfaces cung cấp bởi Spark SQL có thêm các thông tin về cấu trúc của dữ liệu và các tính toán đang được thực hiện. V...</p></div></div></a></div><div class="card"> <a href="/posts/retail-data-analytics-with-spark-sql/"><div class="card-body"> <span class="timeago small" > Sep 2, 2021 <i class="unloaded">2021-09-02T20:52:00+07:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Phân tích dữ liệu bán lẻ với Spark SQL</h3><div class="text-muted small"><p> Như đã tìm hiểu ở bài viết trước về Spark SQL, Dataframe và Dataset, Spark SQL là một mô hình để xử lý dữ liệu có cấu trúc của Spark rất phổ biến. Trong bài viết này chúng ta sẽ sử dụng Spark SQL đ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/retail-data-analytics-with-spark-sql/" class="btn btn-outline-primary" prompt="Older"><p>Phân tích dữ liệu bán lẻ với Spark SQL</p></a> <a href="/posts/spark-sql-window-function-pivot-part-2/" class="btn btn-outline-primary" prompt="Newer"><p>Window function, pivot trong Spark SQL (Part 2)</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://twitter.com/DeManejar">demanejar</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div></div><script type="text/javascript"> var links = document.links; for (var i = 0, linksLength = links.length; i < linksLength; i++) { if (links[i].hostname != window.location.hostname) { links[i].target = '_blank'; } } </script></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/bigdata/">Bigdata</a> <a class="post-tag" href="/tags/spark/">Spark</a> <a class="post-tag" href="/tags/crawler/">Crawler</a> <a class="post-tag" href="/tags/hdfs/">HDFS</a> <a class="post-tag" href="/tags/scrapy/">Scrapy</a> <a class="post-tag" href="/tags/hadoop/">Hadoop</a> <a class="post-tag" href="/tags/apache-hadoop/">Apache Hadoop</a> <a class="post-tag" href="/tags/ubuntu/">Ubuntu</a> <a class="post-tag" href="/tags/spark-sql/">Spark SQL</a> <a class="post-tag" href="/tags/alonhadat/">alonhadat</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js"></script> <script> $(function() { let initTheme = "default"; if ($("html[mode=dark]").length > 0 || ($("html[mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches ) ) { initTheme = "dark"; } let mermaidConf = { theme: initTheme /* <default|dark|forest|neutral> */ }; /* Markdown converts to HTML */ $("pre").has("code.language-mermaid").each(function() { let svgCode = $(this).children().html(); $(this).addClass("unloaded"); $(this).after(`<div class=\"mermaid\">${svgCode}</div>`); }); mermaid.initialize(mermaidConf); }); </script><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://demanejar.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
