<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta property="og:image" content="https://raw.githubusercontent.com/demanejar/image-collection/refs/heads/main/Scrapy-Selenium/scrapy_selenium_middleware.png"> <script async src="https://www.googletagmanager.com/gtag/js?id=G-9TR0K3B846"></script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8714452693053438" crossorigin="anonymous"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-9TR0K3B846'); </script><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="Cài đặt Selenium Middleware cho Scrapy" /><meta name="author" content="trannguyenhan" /><meta property="og:locale" content="en_US" /><meta name="description" content="Scrapy có cung cấp thư viện scrapy-selenium cho phép việc sử dụng Seleinum để lấy dữ liệu trang web trước khi trả về cho spdier xử lý. Tuy nhiên trong 1 số trường hợp ví dụ mình không muốn dùng selenium bình thường mà mình muốn dùng undetected-chromedriver vì nó giúp bypass Cloudflare trên website, muốn add proxy thông qua extension của chrome, muốn scroll lên xuống và một số hành động trước khi vào spider,… thì việc sử dụng thư viện sẽ là rất hạn chế. việc xử dụng thư viện cũng rất tiện lợi trong 1 số trường hợp đơn giản và mình sẽ giới thiệu trong bài viết sau. Trong bài viết này mình sẽ nói về việc sử dụng undetected-chromedriver xây dựng SeleniumMiddleware bypass Cloudflare website." /><meta property="og:description" content="Scrapy có cung cấp thư viện scrapy-selenium cho phép việc sử dụng Seleinum để lấy dữ liệu trang web trước khi trả về cho spdier xử lý. Tuy nhiên trong 1 số trường hợp ví dụ mình không muốn dùng selenium bình thường mà mình muốn dùng undetected-chromedriver vì nó giúp bypass Cloudflare trên website, muốn add proxy thông qua extension của chrome, muốn scroll lên xuống và một số hành động trước khi vào spider,… thì việc sử dụng thư viện sẽ là rất hạn chế. việc xử dụng thư viện cũng rất tiện lợi trong 1 số trường hợp đơn giản và mình sẽ giới thiệu trong bài viết sau. Trong bài viết này mình sẽ nói về việc sử dụng undetected-chromedriver xây dựng SeleniumMiddleware bypass Cloudflare website." /><link rel="canonical" href="https://demanejar.github.io/posts/selenium-middleware-custom-scrapy/" /><meta property="og:url" content="https://demanejar.github.io/posts/selenium-middleware-custom-scrapy/" /><meta property="og:site_name" content="De Manejar" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-12-03T20:52:00+07:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Cài đặt Selenium Middleware cho Scrapy" /><meta name="twitter:site" content="@DeManejar" /><meta name="twitter:creator" content="@trannguyenhan" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"trannguyenhan"},"dateModified":"2024-12-03T21:53:56+07:00","datePublished":"2024-12-03T20:52:00+07:00","description":"Scrapy có cung cấp thư viện scrapy-selenium cho phép việc sử dụng Seleinum để lấy dữ liệu trang web trước khi trả về cho spdier xử lý. Tuy nhiên trong 1 số trường hợp ví dụ mình không muốn dùng selenium bình thường mà mình muốn dùng undetected-chromedriver vì nó giúp bypass Cloudflare trên website, muốn add proxy thông qua extension của chrome, muốn scroll lên xuống và một số hành động trước khi vào spider,… thì việc sử dụng thư viện sẽ là rất hạn chế. việc xử dụng thư viện cũng rất tiện lợi trong 1 số trường hợp đơn giản và mình sẽ giới thiệu trong bài viết sau. Trong bài viết này mình sẽ nói về việc sử dụng undetected-chromedriver xây dựng SeleniumMiddleware bypass Cloudflare website.","headline":"Cài đặt Selenium Middleware cho Scrapy","mainEntityOfPage":{"@type":"WebPage","@id":"https://demanejar.github.io/posts/selenium-middleware-custom-scrapy/"},"url":"https://demanejar.github.io/posts/selenium-middleware-custom-scrapy/"}</script><title>Cài đặt Selenium Middleware cho Scrapy | De Manejar</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script> /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */ MathJax = { tex: { inlineMath: [ /* start/end delimiter pairs for in-line math */ ['$','$'], ['\\(','\\)'] ], displayMath: [ /* start/end delimiter pairs for display math */ ['$$', '$$'], ['\\[', '\\]'] ] } }; </script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"> </script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://i.pinimg.com/564x/9c/32/79/9c3279b5ac960533cbcb7e833ac4d947.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">De Manejar</a></div><div class="site-subtitle font-italic">Hello Bigdata !</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/demanejar" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/DeManejar" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['demanejar','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Cài đặt Selenium Middleware cho Scrapy</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Cài đặt Selenium Middleware cho Scrapy</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> trannguyenhan </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Tue, Dec 3, 2024, 8:52 PM +0700" prep="on" > Dec 3, 2024 <i class="unloaded">2024-12-03T20:52:00+07:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Tue, Dec 3, 2024, 9:53 PM +0700" prefix="Updated " > Dec 3, 2024 <i class="unloaded">2024-12-03T21:53:56+07:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="472 words">2 min</span></div></div><div class="post-content"><p>Scrapy có cung cấp thư viện <a href="https://pypi.org/project/scrapy-selenium/">scrapy-selenium</a> cho phép việc sử dụng Seleinum để lấy dữ liệu trang web trước khi trả về cho spdier xử lý. Tuy nhiên trong 1 số trường hợp ví dụ mình không muốn dùng selenium bình thường mà mình muốn dùng undetected-chromedriver vì nó giúp bypass Cloudflare trên website, muốn add proxy thông qua extension của chrome, muốn scroll lên xuống và một số hành động trước khi vào spider,… thì việc sử dụng thư viện sẽ là rất hạn chế. việc xử dụng thư viện cũng rất tiện lợi trong 1 số trường hợp đơn giản và mình sẽ giới thiệu trong bài viết sau. Trong bài viết này mình sẽ nói về việc sử dụng <a href="https://pypi.org/project/undetected-chromedriver/">undetected-chromedriver</a> xây dựng SeleniumMiddleware bypass Cloudflare website.</p><h2 id="khởi-tạo-project">Khởi tạo project</h2><p>Khởi tạo một project scrapy:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>scrapy startproject seleniummiddlewarescrapydemo
</pre></table></code></div></div><p>Tạo một spider để crawl dữ liệu, ở đây mình crawl dữ liệu từ trang <code class="language-plaintext highlighter-rouge">vinpearl.com/</code>:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>scrapy genspider vinpearl_dot_com https://vinpearl.com/vi/news/ha-noi
</pre></table></code></div></div><p>Cài đặt thư viện cần thết:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>pip <span class="nb">install </span>scrapy
pip <span class="nb">install </span>scrapy-selenium
</pre></table></code></div></div><h2 id="seleniummiddleware">SeleniumMiddleware</h2><p>Tạo class <code class="language-plaintext highlighter-rouge">SeleniumBaseMiddleware</code> như sau:</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">SeleniumBaseMiddleWare</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_crawler</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">crawler</span><span class="p">):</span>
        <span class="n">middleware</span> <span class="o">=</span> <span class="nf">cls</span><span class="p">()</span>
        <span class="n">crawler</span><span class="p">.</span><span class="n">signals</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">middleware</span><span class="p">.</span><span class="n">spider_opened</span><span class="p">,</span> <span class="n">signals</span><span class="p">.</span><span class="n">spider_opened</span><span class="p">)</span>
        <span class="n">crawler</span><span class="p">.</span><span class="n">signals</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">middleware</span><span class="p">.</span><span class="n">spider_closed</span><span class="p">,</span> <span class="n">signals</span><span class="p">.</span><span class="n">spider_closed</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">middleware</span>

    <span class="k">def</span> <span class="nf">get_chrome_options</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">options</span> <span class="o">=</span> <span class="n">uc</span><span class="p">.</span><span class="nc">ChromeOptions</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">options</span>

    <span class="k">def</span> <span class="nf">spider_opened</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spider</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">options</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_chrome_options</span><span class="p">()</span>

            <span class="n">self</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">uc</span><span class="p">.</span><span class="nc">Chrome</span><span class="p">(</span>
                <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span>
                <span class="n">version_main</span><span class="o">=</span><span class="mi">127</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Failed to open spider and create driver: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">raise</span>

    <span class="k">def</span> <span class="nf">process_request</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">spider</span><span class="p">):</span>
        <span class="n">logging</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">'</span><span class="s">SELENIUM FETCH URL {}</span><span class="sh">'</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">url</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">driver</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">url</span><span class="p">)</span>

        <span class="n">request</span><span class="p">.</span><span class="n">meta</span><span class="p">.</span><span class="nf">update</span><span class="p">({</span><span class="sh">'</span><span class="s">driver</span><span class="sh">'</span><span class="p">:</span> <span class="n">self</span><span class="p">.</span><span class="n">driver</span><span class="p">})</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">driver</span><span class="p">.</span><span class="n">page_source</span>
        <span class="k">return</span> <span class="nc">HtmlResponse</span><span class="p">(</span>
            <span class="n">request</span><span class="p">.</span><span class="n">url</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="sh">"</span><span class="s">utf-8</span><span class="sh">"</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">content</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="n">request</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">process_response</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">spider</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">response</span>
    
    <span class="k">def</span> <span class="nf">spider_closed</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">spider</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">driver</span><span class="p">.</span><span class="nf">quit</span><span class="p">()</span>
</pre></table></code></div></div><ul><li><p><code class="language-plaintext highlighter-rouge">spider_opened()</code> khởi tạo <code class="language-plaintext highlighter-rouge">driver</code> và các tham số cần thiết, ví dụ như là <code class="language-plaintext highlighter-rouge">options</code> hay nếu có thêm proxy chúng ta cũng sẽ thêm proxy tại đây.</p><li><p><code class="language-plaintext highlighter-rouge">spider_closed()</code> tắt <code class="language-plaintext highlighter-rouge">driver</code> sau khi kết thúc crawl.</p><li><p><code class="language-plaintext highlighter-rouge">process_request()</code> xử lý việc lấy về dữ liệu, gán <code class="language-plaintext highlighter-rouge">request.meta.update({'driver': self.driver})</code> để sử dụng driver phía trong spider nếu cần thiêt.</p></ul><p>Trong spider <code class="language-plaintext highlighter-rouge">vinpearl_dot_com</code> nếu có những tác vụ mà cần sử dụng <code class="language-plaintext highlighter-rouge">driver</code> như scroll lên xuống, click button thì sẽ lấy ra <code class="language-plaintext highlighter-rouge">driver</code> như sau:</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">driver</span> <span class="o">=</span> <span class="n">response</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">meta</span><span class="p">[</span><span class="sh">"</span><span class="s">driver</span><span class="sh">"</span><span class="p">]</span>
<span class="n">driver</span><span class="p">.</span><span class="nf">execute_script</span><span class="p">(</span>
    <span class="sh">"</span><span class="s">window.scrollTo(0, document.body.scrollHeight);</span><span class="sh">"</span>
<span class="p">)</span>
</pre></table></code></div></div><p>Với điều kiện là <code class="language-plaintext highlighter-rouge">driver</code> đã được update vào trong request của middleware trước đó <code class="language-plaintext highlighter-rouge">request.meta.update({'driver': self.driver})</code> như trong SeleniumBaseMiddleware.</p><p>Trong file <code class="language-plaintext highlighter-rouge">settings</code> thêm SeleniumBaseMiddleware vào trong DOWNLOADER_MIDDLEWARES:</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">DOWNLOADER_MIDDLEWARES</span> <span class="o">=</span> <span class="p">{</span>
   <span class="sh">"</span><span class="s">seleniummiddlewarescrapydemo.middlewares.SeleniumBaseMiddleWare</span><span class="sh">"</span><span class="p">:</span> <span class="mi">543</span><span class="p">,</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Bây giờ việc crawl website rất là dễ dàng khi không còn bị chặn bởi Cloudflare và đã gen toàn bộ mã Javascript của website động thành HTML để dễ dàng phân tích.</p><p>Toàn bộ project xem tại: <a href="https://github.com/demanejar/selenium-middleware-scrapy-demo">https://github.com/demanejar/selenium-middleware-scrapy-demo</a></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/crawler/'>Crawler</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/crawler/" class="post-tag no-text-decoration" >Crawler</a> <a href="/tags/selenium/" class="post-tag no-text-decoration" >Selenium</a> <a href="/tags/scrapy/" class="post-tag no-text-decoration" >Scrapy</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Cài đặt Selenium Middleware cho Scrapy - De Manejar&url=https://demanejar.github.io/posts/selenium-middleware-custom-scrapy/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Cài đặt Selenium Middleware cho Scrapy - De Manejar&u=https://demanejar.github.io/posts/selenium-middleware-custom-scrapy/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Cài đặt Selenium Middleware cho Scrapy - De Manejar&url=https://demanejar.github.io/posts/selenium-middleware-custom-scrapy/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/k8s/">Tìm hiểu tổng quan k8s</a><li><a href="/posts/add-proxy-to-scrapy-project/">Cấu hình proxy cho project Scrapy</a><li><a href="/posts/crawl-1000-website-new-with-scrapy/">Crawl 1000 trang báo với Scrapy và MySQL</a><li><a href="/posts/php-scraper/">PHP Scraper</a><li><a href="/posts/scrapy-shell/">Giới thiệu Scrapy Shell</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/bigdata/">Bigdata</a> <a class="post-tag" href="/tags/spark/">Spark</a> <a class="post-tag" href="/tags/crawler/">Crawler</a> <a class="post-tag" href="/tags/hdfs/">HDFS</a> <a class="post-tag" href="/tags/scrapy/">Scrapy</a> <a class="post-tag" href="/tags/hadoop/">Hadoop</a> <a class="post-tag" href="/tags/apache-hadoop/">Apache Hadoop</a> <a class="post-tag" href="/tags/ubuntu/">Ubuntu</a> <a class="post-tag" href="/tags/spark-sql/">Spark SQL</a> <a class="post-tag" href="/tags/alonhadat/">alonhadat</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/what-is-crawler-and-something/"><div class="card-body"> <span class="timeago small" > Jan 12, 2023 <i class="unloaded">2023-01-12T20:52:00+07:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Crawler, một số điều mình chia sẻ về crawler và loạt bài viết về crawler sắp tới?</h3><div class="text-muted small"><p> Crawler, Web Scrape, Web Scraping, thu thập dữ liệu, cào dữ liệu,… chắc là các từ ngữ mà chúng ta hay sử dụng nhất để nói về các công việc tạo ra những chương trình đi phân tích và lấy dữ liệu từ m...</p></div></div></a></div><div class="card"> <a href="/posts/no-need-protected-website-from-scraping/"><div class="card-body"> <span class="timeago small" > Jan 24, 2023 <i class="unloaded">2023-01-24T20:52:00+07:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Tại sao những người làm website không hoàn toàn muốn bảo vệ website của họ khỏi bị crawl?</h3><div class="text-muted small"><p> Các website hiện nay thì đã không còn dễ lấy dữ liệu như ngày trước nữa vì cấu trúc của các website bây giờ cũng khác xưa rất là nhiều, nó không có các phần được định nghĩa rõ ràng để phân tích nh...</p></div></div></a></div><div class="card"> <a href="/posts/add-proxy-to-scrapy-project/"><div class="card-body"> <span class="timeago small" > Feb 15, 2023 <i class="unloaded">2023-02-15T20:52:00+07:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Cấu hình proxy cho project Scrapy</h3><div class="text-muted small"><p> Proxy chắc là khái niệm đã không còn xa lạ gì với tất cả mọi người. Với người làm về crawl dữ liệu thì proxy như vật bất ly thân. Trong bài viết này, mình sẽ hướng dẫn cách cấu hình proxy cho proje...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/some-trick-crawler/" class="btn btn-outline-primary" prompt="Older"><p>Một số thủ thuật nhỏ khi crawl data</p></a> <a href="/posts/k8s/" class="btn btn-outline-primary" prompt="Newer"><p>Tìm hiểu tổng quan k8s</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://twitter.com/DeManejar">demanejar</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div></div><script type="text/javascript"> var links = document.links; for (var i = 0, linksLength = links.length; i < linksLength; i++) { if (links[i].hostname != window.location.hostname) { links[i].target = '_blank'; } } </script></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/bigdata/">Bigdata</a> <a class="post-tag" href="/tags/spark/">Spark</a> <a class="post-tag" href="/tags/crawler/">Crawler</a> <a class="post-tag" href="/tags/hdfs/">HDFS</a> <a class="post-tag" href="/tags/scrapy/">Scrapy</a> <a class="post-tag" href="/tags/hadoop/">Hadoop</a> <a class="post-tag" href="/tags/apache-hadoop/">Apache Hadoop</a> <a class="post-tag" href="/tags/ubuntu/">Ubuntu</a> <a class="post-tag" href="/tags/spark-sql/">Spark SQL</a> <a class="post-tag" href="/tags/alonhadat/">alonhadat</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js"></script> <script> $(function() { let initTheme = "default"; if ($("html[mode=dark]").length > 0 || ($("html[mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches ) ) { initTheme = "dark"; } let mermaidConf = { theme: initTheme /* <default|dark|forest|neutral> */ }; /* Markdown converts to HTML */ $("pre").has("code.language-mermaid").each(function() { let svgCode = $(this).children().html(); $(this).addClass("unloaded"); $(this).after(`<div class=\"mermaid\">${svgCode}</div>`); }); mermaid.initialize(mermaidConf); }); </script><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://demanejar.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
