<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta property="og:image" content="https://raw.githubusercontent.com/demanejar/image-collection/refs/heads/main/SparkWindowFunction/cc38cddba42b235e5e23638e9473b7d8.jpg"> <script async src="https://www.googletagmanager.com/gtag/js?id=G-9TR0K3B846"></script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8714452693053438" crossorigin="anonymous"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-9TR0K3B846'); </script><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="Window function, pivot trong Spark SQL (Part 2)" /><meta name="author" content="trannguyenhan" /><meta property="og:locale" content="en_US" /><meta name="description" content="Nếu bạn chưa xem phần 1 thì có thể xem lại TẠI ĐÂY nha, bài viết hôm nay mình sẽ giới thiệu tiếp tới mọi người một số ví dụ về window function và pivot sâu hơn để mọi người có thể hiểu rõ hơn về window function và pivot trong Spark" /><meta property="og:description" content="Nếu bạn chưa xem phần 1 thì có thể xem lại TẠI ĐÂY nha, bài viết hôm nay mình sẽ giới thiệu tiếp tới mọi người một số ví dụ về window function và pivot sâu hơn để mọi người có thể hiểu rõ hơn về window function và pivot trong Spark" /><link rel="canonical" href="https://demanejar.github.io/posts/spark-sql-window-function-pivot-part-2/" /><meta property="og:url" content="https://demanejar.github.io/posts/spark-sql-window-function-pivot-part-2/" /><meta property="og:site_name" content="De Manejar" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-09-14T08:52:00+07:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Window function, pivot trong Spark SQL (Part 2)" /><meta name="twitter:site" content="@DeManejar" /><meta name="twitter:creator" content="@trannguyenhan" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"trannguyenhan"},"dateModified":"2025-03-17T06:29:35+07:00","datePublished":"2021-09-14T08:52:00+07:00","description":"Nếu bạn chưa xem phần 1 thì có thể xem lại TẠI ĐÂY nha, bài viết hôm nay mình sẽ giới thiệu tiếp tới mọi người một số ví dụ về window function và pivot sâu hơn để mọi người có thể hiểu rõ hơn về window function và pivot trong Spark","headline":"Window function, pivot trong Spark SQL (Part 2)","mainEntityOfPage":{"@type":"WebPage","@id":"https://demanejar.github.io/posts/spark-sql-window-function-pivot-part-2/"},"url":"https://demanejar.github.io/posts/spark-sql-window-function-pivot-part-2/"}</script><title>Window function, pivot trong Spark SQL (Part 2) | De Manejar</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script> /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */ MathJax = { tex: { inlineMath: [ /* start/end delimiter pairs for in-line math */ ['$','$'], ['\\(','\\)'] ], displayMath: [ /* start/end delimiter pairs for display math */ ['$$', '$$'], ['\\[', '\\]'] ] } }; </script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"> </script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://i.pinimg.com/564x/9c/32/79/9c3279b5ac960533cbcb7e833ac4d947.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">De Manejar</a></div><div class="site-subtitle font-italic">Hello Bigdata !</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/demanejar" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/DeManejar" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['demanejar','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Window function, pivot trong Spark SQL (Part 2)</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Window function, pivot trong Spark SQL (Part 2)</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> trannguyenhan </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Tue, Sep 14, 2021, 8:52 AM +0700" prep="on" > Sep 14, 2021 <i class="unloaded">2021-09-14T08:52:00+07:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Mon, Mar 17, 2025, 6:29 AM +0700" prefix="Updated " > Mar 17 <i class="unloaded">2025-03-17T06:29:35+07:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1834 words">10 min</span></div></div><div class="post-content"><p><em>Nếu bạn chưa xem phần 1 thì có thể xem lại <a href="https://demanejar.github.io/posts/spark-sql-window-function-pivot/">TẠI ĐÂY</a> nha, bài viết hôm nay mình sẽ giới thiệu tiếp tới mọi người một số ví dụ về window function và pivot sâu hơn để mọi người có thể hiểu rõ hơn về window function và pivot trong Spark</em></p><h2 id="example-5-window-function">Example 5: Window function</h2><h3 id="yêu-cầu">Yêu cầu</h3><p>Cho tập dữ liệu dạng <em>.csv</em> như sau:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="nb">time</span>,department,items_sold,running_total
1,IT,15,15
2,Support,81,81
3,Support,90,171
4,Support,25,196
5,IT,40,55
6,IT,24,79
7,Support,31,227
8,Support,1,228
9,HR,27,27
10,IT,75,154
</pre></table></code></div></div><ul><li>Đọc dữ liệu vào spark từ file csv chứa dữ liệu.<li>Dùng SparkSQL query độ lệch giữa các running_total liên tiếp nhau theo thời gian của các department</ul><p>INPUT:</p><div class="table-wrapper"><table><thead><tr><th>time<th>department<th>items_sold<th>running_total<tbody><tr><td>1<td>IT<td>15<td>15<tr><td>2<td>Support<td>81<td>81<tr><td>3<td>Support<td>90<td>171<tr><td>4<td>Support<td>25<td>196<tr><td>5<td>IT<td>40<td>55<tr><td>6<td>IT<td>24<td>79<tr><td>7<td>Support<td>31<td>227<tr><td>8<td>Support<td>1<td>228<tr><td>9<td>HR<td>27<td>27<tr><td>10<td>IT<td>75<td>154</table></div><p>OUTPUT:</p><div class="table-wrapper"><table><thead><tr><th>time<th>department<th>items_sold<th>running_total<th>diff<tbody><tr><td>9<td>HR<td>27<td>27<td>27<tr><td>1<td>IT<td>15<td>15<td>15<tr><td>5<td>IT<td>40<td>55<td>40<tr><td>6<td>IT<td>24<td>79<td>24<tr><td>10<td>IT<td>75<td>154<td>75<tr><td>2<td>Support<td>81<td>81<td>81<tr><td>3<td>Support<td>90<td>171<td>90<tr><td>4<td>Support<td>25<td>196<td>25<tr><td>7<td>Support<td>31<td>227<td>31<tr><td>8<td>Support<td>1<td>228<td>1</table></div><h3 id="lời-giải">Lời giải</h3><p>Chúng ta sẽ thấy là bài này giống bài tính tổng tích lũy tại <a href="https://demanejar.github.io/posts/spark-sql-window-function-pivot/#example-4-window-function">Ví dụ 4</a> chỉ khác là tại ví dụ này chúng ta sẽ đi tính hiệu giữa 2 <em>running_total</em> liên tiếp mà không phải là tổng.</p><p>Để giải quyết bài này thì mình đưa ra một lời giải hơi phức tạp 1 tí như sau:</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">part5</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.spark.sql.Dataset</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.Row</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.SparkSession</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.functions</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.expressions.Window</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.expressions.WindowSpec</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">SparkSession</span> <span class="n">spark</span> <span class="o">=</span> <span class="nc">SparkSession</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">appName</span><span class="o">(</span><span class="s">"Bai_5"</span><span class="o">).</span><span class="na">master</span><span class="o">(</span><span class="s">"local"</span><span class="o">).</span><span class="na">getOrCreate</span><span class="o">();</span>
		<span class="nc">Dataset</span><span class="o">&lt;</span><span class="nc">Row</span><span class="o">&gt;</span> <span class="n">data</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="na">read</span><span class="o">().</span><span class="na">option</span><span class="o">(</span><span class="s">"header"</span><span class="o">,</span> <span class="kc">true</span><span class="o">).</span><span class="na">option</span><span class="o">(</span><span class="s">"inferSchema"</span><span class="o">,</span> <span class="kc">true</span><span class="o">).</span><span class="na">csv</span><span class="o">(</span><span class="s">"src/part5/input.csv"</span><span class="o">);</span>
		
		<span class="nc">WindowSpec</span> <span class="n">wins</span> <span class="o">=</span> <span class="nc">Window</span><span class="o">.</span><span class="na">partitionBy</span><span class="o">(</span><span class="s">"department"</span><span class="o">)</span>
				<span class="o">.</span><span class="na">orderBy</span><span class="o">(</span><span class="s">"time"</span><span class="o">)</span>
				<span class="o">.</span><span class="na">rowsBetween</span><span class="o">(</span><span class="nc">Window</span><span class="o">.</span><span class="na">currentRow</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">,</span> <span class="nc">Window</span><span class="o">.</span><span class="na">currentRow</span><span class="o">());</span>
		
		<span class="nc">Dataset</span><span class="o">&lt;</span><span class="nc">Row</span><span class="o">&gt;</span> <span class="n">result_1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="na">withColumn</span><span class="o">(</span><span class="s">"diff_sum"</span><span class="o">,</span> <span class="n">functions</span><span class="o">.</span><span class="na">sum</span><span class="o">(</span><span class="s">"running_total"</span><span class="o">).</span><span class="na">over</span><span class="o">(</span><span class="n">wins</span><span class="o">));</span>
		<span class="nc">Dataset</span><span class="o">&lt;</span><span class="nc">Row</span><span class="o">&gt;</span> <span class="n">result_2</span> <span class="o">=</span> <span class="n">result_1</span><span class="o">.</span><span class="na">withColumn</span><span class="o">(</span><span class="s">"diff_1"</span><span class="o">,</span> <span class="n">functions</span><span class="o">.</span><span class="na">max</span><span class="o">(</span><span class="s">"running_total"</span><span class="o">).</span><span class="na">over</span><span class="o">(</span><span class="n">wins</span><span class="o">));</span>
		<span class="n">result_2</span><span class="o">.</span><span class="na">createOrReplaceTempView</span><span class="o">(</span><span class="s">"data_1"</span><span class="o">);</span>
		
		<span class="n">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">(</span><span class="s">"select time, department, items_sold, running_total, diff_1, diff_sum - diff_1 as diff_2 from data_1"</span><span class="o">)</span>
				<span class="o">.</span><span class="na">createOrReplaceTempView</span><span class="o">(</span><span class="s">"data_2"</span><span class="o">);</span>
		
		<span class="nc">Dataset</span><span class="o">&lt;</span><span class="nc">Row</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">(</span><span class="s">"select time, department, items_sold, running_total, diff_1 - diff_2 as diff from data_2"</span><span class="o">);</span>
		<span class="n">result</span><span class="o">.</span><span class="na">show</span><span class="o">();</span>
		
	<span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>Ngắn gọn lại lời giải trên, thì để tính được cột <em>diff</em> ta sẽ lấy tổng của <em>running_total</em> của hàng hiện và hàng trước đó trừ đi <em>running_total</em> của hàng hiện tại để lấy ra <em>running_total</em> của hàng trước đó, gọi cột mới này là cột <em>diff_2</em>. Sau đó lấy <em>running_total</em> của mỗi hàng hiện tại trừ đi <em>running_total</em> của hàng trước đó (là cột <em>diff_2</em>) thì ta sẽ ra được kết quả. Sở dĩ làm phức tạp như vậy mà không lấy luôn <em>running_total</em> của hàng trước đó qua <em>window function</em> là để tránh đi kết quả <code class="language-plaintext highlighter-rouge">null</code>, nếu ta lấy luôn giá trị <em>running_total</em> của hàng trước đó bằng <em>window function</em> sau:</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nc">WindowSpec</span> <span class="n">wins</span> <span class="o">=</span> <span class="nc">Window</span><span class="o">.</span><span class="na">partitionBy</span><span class="o">(</span><span class="s">"department"</span><span class="o">).</span><span class="na">orderBy</span><span class="o">(</span><span class="s">"time"</span><span class="o">).</span><span class="na">rowsBetween</span><span class="o">(</span><span class="nc">Window</span><span class="o">.</span><span class="na">currentRow</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">,</span> <span class="nc">Window</span><span class="o">.</span><span class="na">currentRow</span><span class="o">()-</span><span class="mi">1</span><span class="o">);</span>
</pre></table></code></div></div><p>Thì ta sẽ tạo được thêm cột mới là giá trị <em>running_total</em> của hàng trước đó và công việc bây giờ chỉ cần trừ đi sẽ có được kết quả cuối cùng, đơn giản như vậy nhưng kết quả của phương pháp trên bị vướng giá trị <code class="language-plaintext highlighter-rouge">null</code> như dưới đây:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre>+----+----------+----------+-------------+----+
|time|department|items_sold|running_total|diff|
+----+----------+----------+-------------+----+
|   9|        HR|        27|           27|null|
|   1|        IT|        15|           15|null|
|   5|        IT|        40|           55|  40|
|   6|        IT|        24|           79|  24|
|  10|        IT|        75|          154|  75|
|   2|   Support|        81|           81|null|
|   3|   Support|        90|          171|  90|
|   4|   Support|        25|          196|  25|
|   7|   Support|        31|          227|  31|
|   8|   Support|         1|          228|   1|
+----+----------+----------+-------------+----+
</pre></table></code></div></div><p>Và mình vẫn chưa tìm được cách <code class="language-plaintext highlighter-rouge">replace</code> giá trị <code class="language-plaintext highlighter-rouge">null</code> kia thế nên mình giải quyết bài toán này bằng 1 phương pháp hơi phức tạp như trên.</p><h2 id="example-6-window-function">Example 6: Window function</h2><h3 id="yêu-cầu-1">Yêu cầu</h3><p>Cho tập dữ liệu đầu vào <em>.csv</em> như sau:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="nb">id</span>,name,department,salary
1,Hunter Fields,IT,15
2,Leonard Lewis,Support,81
3,Jason Dawson,Support,90
4,Andre Grant,Support,25
5,Earl Walton,IT,40
6,Alan Hanson,IT,24
7,Clyde Matthews,Support,31
8,Josephine Leonard,Support,1
9,Owen Boone,HR,27
10,Max McBride,IT,75
</pre></table></code></div></div><ul><li>Đọc dữ liệu vào spark từ file csv<li>Tìm sự chênh lệch salary giữa nhân viên có lương cao nhất với các nhân viên còn lại trong từng phòng ban</ul><p>INPUT:</p><div class="table-wrapper"><table><thead><tr><th>id<th>name<th>department<th>salary<tbody><tr><td>1<td>Hunter Fields<td>IT<td>15<tr><td>2<td>Leonard Lewis<td>Support<td>81<tr><td>3<td>Jason Dawson<td>Support<td>90<tr><td>4<td>Andre Grant<td>Support<td>25<tr><td>5<td>Earl Walton<td>IT<td>40<tr><td>6<td>Alan Hanson<td>IT<td>24<tr><td>7<td>Clyde Matthews<td>Support<td>31<tr><td>8<td>Josephine Leonard<td>Support<td>1<tr><td>9<td>Owen Boone<td>HR<td>27<tr><td>10<td>Max McBride<td>IT<td>75</table></div><p>OUTPUT:</p><div class="table-wrapper"><table><thead><tr><th>id<th>name<th>department<th>salary<th>diff<tbody><tr><td>9<td>Owen Boone<td>HR<td>27<td>0<tr><td>1<td>Hunter Fields<td>IT<td>15<td>60<tr><td>5<td>Earl Walton<td>IT<td>40<td>35<tr><td>6<td>Alan Hanson<td>IT<td>24<td>51<tr><td>10<td>Max McBride<td>IT<td>75<td>0<tr><td>2<td>Leonard Lewis<td>Support<td>81<td>9<tr><td>3<td>Jason Dawson<td>Support<td>90<td>0<tr><td>4<td>Andre Grant<td>Support<td>25<td>65<tr><td>7<td>Clyde Matthews<td>Support<td>31<td>59<tr><td>8<td>Josephine Leonard<td>Support<td>1<td>89</table></div><h3 id="lời-giải-1">Lời giải</h3><p>Bài này khá là đơn giản hơn so với các bài bên trên, chúng ta chỉ cần tìm ra giá trị <code class="language-plaintext highlighter-rouge">max</code> của <em>department</em> và trừ đi là xong:</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">part6</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.spark.sql.Dataset</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.Row</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.SparkSession</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.functions</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.expressions.Window</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.expressions.WindowSpec</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">SparkSession</span> <span class="n">spark</span> <span class="o">=</span> <span class="nc">SparkSession</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">appName</span><span class="o">(</span><span class="s">"Bai_6"</span><span class="o">).</span><span class="na">master</span><span class="o">(</span><span class="s">"local"</span><span class="o">).</span><span class="na">getOrCreate</span><span class="o">();</span>
		<span class="nc">Dataset</span><span class="o">&lt;</span><span class="nc">Row</span><span class="o">&gt;</span> <span class="n">data</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="na">read</span><span class="o">().</span><span class="na">option</span><span class="o">(</span><span class="s">"header"</span><span class="o">,</span> <span class="kc">true</span><span class="o">).</span><span class="na">option</span><span class="o">(</span><span class="s">"inferSchema"</span><span class="o">,</span> <span class="kc">true</span><span class="o">).</span><span class="na">csv</span><span class="o">(</span><span class="s">"src/part6/input.csv"</span><span class="o">);</span>
		
		<span class="nc">WindowSpec</span> <span class="n">wins</span> <span class="o">=</span> <span class="nc">Window</span><span class="o">.</span><span class="na">partitionBy</span><span class="o">(</span><span class="s">"department"</span><span class="o">).</span><span class="na">orderBy</span><span class="o">(</span><span class="s">"id"</span><span class="o">)</span>
				<span class="o">.</span><span class="na">rowsBetween</span><span class="o">(</span><span class="nc">Window</span><span class="o">.</span><span class="na">unboundedPreceding</span><span class="o">(),</span> <span class="nc">Window</span><span class="o">.</span><span class="na">unboundedFollowing</span><span class="o">());</span>
		<span class="nc">Dataset</span><span class="o">&lt;</span><span class="nc">Row</span><span class="o">&gt;</span> <span class="n">result_1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="na">withColumn</span><span class="o">(</span><span class="s">"diff_max"</span><span class="o">,</span> <span class="n">functions</span><span class="o">.</span><span class="na">max</span><span class="o">(</span><span class="s">"salary"</span><span class="o">).</span><span class="na">over</span><span class="o">(</span><span class="n">wins</span><span class="o">));</span>
		
		<span class="n">result_1</span><span class="o">.</span><span class="na">createOrReplaceTempView</span><span class="o">(</span><span class="s">"data_1"</span><span class="o">);</span>
		<span class="nc">Dataset</span><span class="o">&lt;</span><span class="nc">Row</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">(</span><span class="s">"select id, name, department, salary, diff_max - salary as diff from data_1"</span><span class="o">);</span>
		
		<span class="n">result</span><span class="o">.</span><span class="na">show</span><span class="o">();</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h2 id="example-7-window-function">Example 7: Window function</h2><h3 id="yêu-cầu-2">Yêu cầu</h3><p>Cho tập dữ liệu dưới dạng đầu vào <em>.csv</em> như sau:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre>Employee,Salary
Tony,50
Alan,45
Lee,60
David,35
Steve,65
Paul,48
Micky,62
George,80
Nigel,64
John,42
</pre></table></code></div></div><ul><li>Load dữ liệu từ file csv<li>Thêm cột Percentage với giá trị được quy định như sau<li>30% số nhân viên đầu có lương cao nhất nhận giá trị “High”<li>40% tiếp theo nhận giá trị “Average”<li>Phần còn lại nhận giá trị “Low”</ul><h3 id="lời-giải-2">Lời giải</h3><p>Thoạt nhìn thì ta sẽ thấy nó đơn giản nhưng nhìn chung nó cũng không được đơn giản cho lắm. Hướng làm cho bài này mà mình đưa ra sẽ là:</p><ul><li>Sắp xếp lại giá trị lương theo thứ tự từ cao tới thấp<li>Đánh số thứ tự cho các nhân viên vừa sắp xếp theo chỉ số giảm dần<li>Tính giá trị nhân viên nằm ở top bao nhiêu phần trăm bằng cách lấy số thự tự của nhân viên vừa được đánh dấu chia cho số thứ tự cao nhất (hay là tổng số nhân viên)<li>Thêm cột <em>Percentage</em> bằng cách những nhân viên nào có giá trị phần trăm tính ở bước trên từ 0.7 tới 1 thì là <em>High</em>, từ 0.3 tới 0.7 thì là <em>Average</em>, từ 0 tới 0.3 là <em>Low</em></ul><p>Mã nguồn lời giải này như sau:</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">part7</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.spark.sql.Dataset</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.Row</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.SparkSession</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.functions</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.expressions.Window</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">SparkSession</span> <span class="n">spark</span> <span class="o">=</span> <span class="nc">SparkSession</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">appName</span><span class="o">(</span><span class="s">"Bai_7"</span><span class="o">).</span><span class="na">master</span><span class="o">(</span><span class="s">"local"</span><span class="o">).</span><span class="na">getOrCreate</span><span class="o">();</span>
		<span class="nc">Dataset</span><span class="o">&lt;</span><span class="nc">Row</span><span class="o">&gt;</span> <span class="n">data</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="na">read</span><span class="o">().</span><span class="na">option</span><span class="o">(</span><span class="s">"header"</span><span class="o">,</span> <span class="kc">true</span><span class="o">).</span><span class="na">option</span><span class="o">(</span><span class="s">"inferSchema"</span><span class="o">,</span> <span class="kc">true</span><span class="o">).</span><span class="na">csv</span><span class="o">(</span><span class="s">"src/part7/input.csv"</span><span class="o">);</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">col</span><span class="o">(</span><span class="s">"Salary"</span><span class="o">).</span><span class="na">desc</span><span class="o">());</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="na">withColumn</span><span class="o">(</span><span class="s">"stt"</span><span class="o">,</span> <span class="n">functions</span><span class="o">.</span><span class="na">rank</span><span class="o">().</span><span class="na">over</span><span class="o">(</span><span class="nc">Window</span><span class="o">.</span><span class="na">orderBy</span><span class="o">(</span><span class="s">"Salary"</span><span class="o">)));</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="na">withColumn</span><span class="o">(</span><span class="s">"Salary_count"</span><span class="o">,</span> <span class="n">functions</span><span class="o">.</span><span class="na">count</span><span class="o">(</span><span class="s">"Salary"</span><span class="o">).</span><span class="na">over</span><span class="o">()).</span><span class="na">sort</span><span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">col</span><span class="o">(</span><span class="s">"Salary"</span><span class="o">).</span><span class="na">desc</span><span class="o">());</span>
		<span class="n">data</span><span class="o">.</span><span class="na">createOrReplaceTempView</span><span class="o">(</span><span class="s">"data"</span><span class="o">);</span>
		
		<span class="nc">Dataset</span><span class="o">&lt;</span><span class="nc">Row</span><span class="o">&gt;</span> <span class="n">data_1</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">(</span><span class="s">"select Employee, Salary, stt / Salary_count as per from data"</span><span class="o">);</span>
		<span class="n">data_1</span><span class="o">.</span><span class="na">createOrReplaceTempView</span><span class="o">(</span><span class="s">"data_1"</span><span class="o">);</span>
		
		<span class="nc">Dataset</span><span class="o">&lt;</span><span class="nc">Row</span><span class="o">&gt;</span> <span class="n">result_1</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">(</span><span class="s">"select Employee, Salary from data_1 where per &gt; 0.7 and per &lt;= 1"</span><span class="o">);</span>
		<span class="n">result_1</span> <span class="o">=</span> <span class="n">result_1</span><span class="o">.</span><span class="na">withColumn</span><span class="o">(</span><span class="s">"Percentage"</span><span class="o">,</span> <span class="n">functions</span><span class="o">.</span><span class="na">lit</span><span class="o">(</span><span class="s">"High"</span><span class="o">));</span>
		
		<span class="nc">Dataset</span><span class="o">&lt;</span><span class="nc">Row</span><span class="o">&gt;</span> <span class="n">result_2</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">(</span><span class="s">"select Employee, Salary from data_1 where per &gt; 0.3 and per &lt;= 0.7"</span><span class="o">);</span>
		<span class="n">result_2</span> <span class="o">=</span> <span class="n">result_2</span><span class="o">.</span><span class="na">withColumn</span><span class="o">(</span> <span class="s">"Percentage"</span><span class="o">,</span> <span class="n">functions</span><span class="o">.</span><span class="na">lit</span><span class="o">(</span><span class="s">"Average"</span><span class="o">));</span>
		
		<span class="nc">Dataset</span><span class="o">&lt;</span><span class="nc">Row</span><span class="o">&gt;</span> <span class="n">result_3</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">(</span><span class="s">"select Employee, Salary from data_1 where per &lt;= 0.3 "</span><span class="o">);</span>
		<span class="n">result_3</span> <span class="o">=</span> <span class="n">result_3</span><span class="o">.</span><span class="na">withColumn</span><span class="o">(</span><span class="s">"Percentage"</span><span class="o">,</span> <span class="n">functions</span><span class="o">.</span><span class="na">lit</span><span class="o">(</span><span class="s">"Low"</span><span class="o">));</span>
		
		<span class="nc">Dataset</span><span class="o">&lt;</span><span class="nc">Row</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">result_1</span><span class="o">.</span><span class="na">union</span><span class="o">(</span><span class="n">result_2</span><span class="o">).</span><span class="na">union</span><span class="o">(</span><span class="n">result_3</span><span class="o">);</span>
		<span class="n">result</span><span class="o">.</span><span class="na">show</span><span class="o">();</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h2 id="example-8-window-function">Example 8: Window function</h2><h3 id="yêu-cầu-3">Yêu cầu</h3><p>Cho tập dữ liệu với đầu vào <em>.csv</em> như sau:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="nb">id</span>,title,genre,quantity
1,Hunter Fields,romance,15
2,Leonard Lewis,thriller,81
3,Jason Dawson,thriller,90
4,Andre Grant,thriller,25
5,Earl Walton,romance,40
6,Alan Hanson,romance,24
7,Clyde Matthews,thriller,31
8,Josephine Leonard,thriller,1
9,Owen Boone,sci-fi,27
10,Max McBride,romance,75
</pre></table></code></div></div><ul><li>Load dữ liệu từ csv<li>Lọc những tilte có số lượng quantity top 1 và top 2 với mỗi genre</ul><h3 id="lời-giải-3">Lời giải</h3><p>Bài này mình có thể giải quyết mà không cần sử dụng <em>windows function</em> như sau:</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">part8</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.spark.sql.Dataset</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.Row</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.SparkSession</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">SparkSession</span> <span class="n">spark</span> <span class="o">=</span> <span class="nc">SparkSession</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">appName</span><span class="o">(</span><span class="s">"Bai_8"</span><span class="o">).</span><span class="na">master</span><span class="o">(</span><span class="s">"local"</span><span class="o">).</span><span class="na">getOrCreate</span><span class="o">();</span>
		<span class="nc">Dataset</span><span class="o">&lt;</span><span class="nc">Row</span><span class="o">&gt;</span> <span class="n">data</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="na">read</span><span class="o">().</span><span class="na">option</span><span class="o">(</span><span class="s">"header"</span><span class="o">,</span> <span class="kc">true</span><span class="o">).</span><span class="na">option</span><span class="o">(</span><span class="s">"inferSchema"</span><span class="o">,</span> <span class="kc">true</span><span class="o">).</span><span class="na">csv</span><span class="o">(</span><span class="s">"src/part8/input.csv"</span><span class="o">);</span>
		
		<span class="n">data</span><span class="o">.</span><span class="na">createOrReplaceTempView</span><span class="o">(</span><span class="s">"data"</span><span class="o">);</span>
		<span class="n">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">(</span><span class="s">"SELECT\n"</span>
				<span class="o">+</span> <span class="s">"  id,\n"</span>
				<span class="o">+</span> <span class="s">"  title,\n"</span>
				<span class="o">+</span> <span class="s">"  genre,\n"</span>
				<span class="o">+</span> <span class="s">"  quantity,\n"</span>
				<span class="o">+</span> <span class="s">"  rank\n"</span>
				<span class="o">+</span> <span class="s">"FROM (\n"</span>
				<span class="o">+</span> <span class="s">"  SELECT\n"</span>
				<span class="o">+</span> <span class="s">"    id,\n"</span>
				<span class="o">+</span> <span class="s">"    title,\n"</span>
				<span class="o">+</span> <span class="s">"    genre,\n"</span>
				<span class="o">+</span> <span class="s">"    quantity,\n"</span>
				<span class="o">+</span> <span class="s">"    dense_rank() OVER (PARTITION BY genre ORDER BY quantity DESC) as rank\n"</span>
				<span class="o">+</span> <span class="s">"  FROM data) tmp\n"</span>
				<span class="o">+</span> <span class="s">"WHERE\n"</span>
				<span class="o">+</span> <span class="s">"  rank &lt;= 2"</span><span class="o">).</span><span class="na">show</span><span class="o">();</span>
		
	<span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h2 id="example-9-pivot">Example 9: pivot</h2><h3 id="yêu-cầu-4">Yêu cầu</h3><p>Cho tập dữ liệu với đầu vào <em>.csv</em> như sau:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>1,Question1Text,Yes,abcde1,0,<span class="s2">"(x1,y1)"</span>
2,Question2Text,No,abcde1,0,<span class="s2">"(x1,y1)"</span>
3,Question3Text,3,abcde1,0,<span class="s2">"(x1,y1)"</span>
1,Question1Text,No,abcde2,0,<span class="s2">"(x2,y2)"</span>
2,Question2Text,Yes,abcde2,0,<span class="s2">"(x2,y2)"</span>
</pre></table></code></div></div><ul><li>Load dữ liệu từ json<li>Tạo báo cáo giống output</ul><p>INPUT:</p><div class="table-wrapper"><table><thead><tr><th>Qid<th>Question<th>AnswerText<th>ParticipantID<th>Assessment<th>GeoTag<tbody><tr><td>1<td>Question1Text<td>Yes<td>abcde1<td>0<td>(x1,y1)<tr><td>2<td>Question2Text<td>No<td>abcde1<td>0<td>(x1,y1)<tr><td>3<td>Question3Text<td>3<td>abcde1<td>0<td>(x1,y1)<tr><td>1<td>Question1Text<td>No<td>abcde2<td>0<td>(x2,y2)<tr><td>2<td>Question2Text<td>Yes<td>abcde2<td>0<td>(x2,y2)</table></div><p>OUTPUT:</p><div class="table-wrapper"><table><thead><tr><th>ParticipantID<th>Assessment<th>GeoTag<th>Qid_1<th>Qid_2<th>Qid_3<tbody><tr><td>abcde1<td>0<td>(x1,y1)<td>Yes<td>No<td>3<tr><td>abcde2<td>0<td>(x2,y2)<td>No<td>Yes<td>null</table></div><h3 id="lời-giải-4">Lời giải</h3><p>Bài này cũng khá tương tự với lại <a href="https://demanejar.github.io/posts/spark-sql-window-function-pivot/#example-3-pivot">ví dụ 3</a>, nên bạn có thể xem lại <a href="https://demanejar.github.io/posts/spark-sql-window-function-pivot/#example-3-pivot">ví dụ 3</a> để hiểu hơn 1 số chỗ phép biến đổi nha:</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">part9</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.spark.sql.Dataset</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.Row</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.SparkSession</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.spark.sql.functions</span><span class="o">;</span>


<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">SparkSession</span> <span class="n">spark</span> <span class="o">=</span> <span class="nc">SparkSession</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">appName</span><span class="o">(</span><span class="s">"Bai_9"</span><span class="o">).</span><span class="na">master</span><span class="o">(</span><span class="s">"local"</span><span class="o">).</span><span class="na">getOrCreate</span><span class="o">();</span>
		<span class="nc">Dataset</span><span class="o">&lt;</span><span class="nc">Row</span><span class="o">&gt;</span> <span class="n">data</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="na">read</span><span class="o">().</span><span class="na">option</span><span class="o">(</span><span class="s">"header"</span><span class="o">,</span> <span class="kc">true</span><span class="o">).</span><span class="na">option</span><span class="o">(</span><span class="s">"inferSchema"</span><span class="o">,</span> <span class="kc">true</span><span class="o">).</span><span class="na">csv</span><span class="o">(</span><span class="s">"src/part9/input.csv"</span><span class="o">);</span>
		
		<span class="nc">Dataset</span><span class="o">&lt;</span><span class="nc">Row</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="na">withColumn</span><span class="o">(</span><span class="s">"concat_Qid"</span><span class="o">,</span> <span class="n">functions</span><span class="o">.</span><span class="na">concat</span><span class="o">(</span><span class="n">functions</span><span class="o">.</span><span class="na">lit</span><span class="o">(</span><span class="s">"Qid_"</span><span class="o">),</span> <span class="n">data</span><span class="o">.</span><span class="na">col</span><span class="o">(</span><span class="s">"Qid"</span><span class="o">)))</span>
				<span class="o">.</span><span class="na">groupBy</span><span class="o">(</span><span class="s">"ParticipantID"</span><span class="o">,</span> <span class="s">"Assessment"</span><span class="o">,</span> <span class="s">"GeoTag"</span><span class="o">).</span><span class="na">pivot</span><span class="o">(</span><span class="s">"concat_Qid"</span><span class="o">).</span><span class="na">agg</span><span class="o">(</span><span class="n">functions</span><span class="o">.</span><span class="na">first</span><span class="o">(</span><span class="s">"AnswerText"</span><span class="o">));</span>
		
		<span class="n">result</span><span class="o">.</span><span class="na">show</span><span class="o">();</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h2 id="tổng-kết">Tổng kết</h2><p>Bạn có thể xem lại toàn bộ mã nguồn của 9 ví dụ trên <a href="https://github.com/demanejar/window-function-pivot-spark-sql">TẠI ĐÂY</a> (Nếu thấy thú vị thì và bổ ích cho nhóm mình 1 star trong repo nha).</p><p>File tổng hợp các ví dụ các bạn có thể xem <a href="https://github.com/demanejar/window-function-pivot-spark-sql/tree/master/resource">TẠI ĐÂY</a>.</p><p>Mong rằng 9 ví dụ này giúp cho các bạn hiểu qua được phần vào về <em>window function</em> và <em>pivot</em> trong Spark SQL hơn.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/hadoop-spark/'>Hadoop & Spark</a>, <a href='/categories/spark/'>Spark</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/spark-sql/" class="post-tag no-text-decoration" >Spark SQL</a> <a href="/tags/bigdata/" class="post-tag no-text-decoration" >Bigdata</a> <a href="/tags/spark/" class="post-tag no-text-decoration" >Spark</a> <a href="/tags/pivot-spark/" class="post-tag no-text-decoration" >pivot spark</a> <a href="/tags/window-function/" class="post-tag no-text-decoration" >window function</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Window function, pivot trong Spark SQL (Part 2) - De Manejar&url=https://demanejar.github.io/posts/spark-sql-window-function-pivot-part-2/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Window function, pivot trong Spark SQL (Part 2) - De Manejar&u=https://demanejar.github.io/posts/spark-sql-window-function-pivot-part-2/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Window function, pivot trong Spark SQL (Part 2) - De Manejar&url=https://demanejar.github.io/posts/spark-sql-window-function-pivot-part-2/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/k8s/">Tìm hiểu tổng quan k8s</a><li><a href="/posts/add-proxy-to-scrapy-project/">Cấu hình proxy cho project Scrapy</a><li><a href="/posts/crawl-1000-website-new-with-scrapy/">Crawl 1000 trang báo với Scrapy và MySQL</a><li><a href="/posts/php-scraper/">PHP Scraper</a><li><a href="/posts/scrapy-shell/">Giới thiệu Scrapy Shell</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/bigdata/">Bigdata</a> <a class="post-tag" href="/tags/spark/">Spark</a> <a class="post-tag" href="/tags/crawler/">Crawler</a> <a class="post-tag" href="/tags/hdfs/">HDFS</a> <a class="post-tag" href="/tags/scrapy/">Scrapy</a> <a class="post-tag" href="/tags/hadoop/">Hadoop</a> <a class="post-tag" href="/tags/apache-hadoop/">Apache Hadoop</a> <a class="post-tag" href="/tags/ubuntu/">Ubuntu</a> <a class="post-tag" href="/tags/spark-sql/">Spark SQL</a> <a class="post-tag" href="/tags/alonhadat/">alonhadat</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/spark-sql-window-function-pivot/"><div class="card-body"> <span class="timeago small" > Sep 9, 2021 <i class="unloaded">2021-09-09T08:52:00+07:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Window function, pivot trong Spark SQL</h3><div class="text-muted small"><p> Window aggregate functions (hay thường được gọi tắt là window functions hoặc windowed aggregates) là hàm giúp hỗ trợ tính toán trên 1 nhóm các bản ghi được gọi là cửa sổ mà có liên quan tới bản ghi...</p></div></div></a></div><div class="card"> <a href="/posts/spark-sql-dataframe-dataset/"><div class="card-body"> <span class="timeago small" > Aug 26, 2021 <i class="unloaded">2021-08-26T20:52:00+07:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Spark SQL, Dataframe và Dataset</h3><div class="text-muted small"><p> Spark SQL là một mô hình để xử lý dữ liệu có cấu trúc của Spark rất phổ biến. Interfaces cung cấp bởi Spark SQL có thêm các thông tin về cấu trúc của dữ liệu và các tính toán đang được thực hiện. V...</p></div></div></a></div><div class="card"> <a href="/posts/retail-data-analytics-with-spark-sql/"><div class="card-body"> <span class="timeago small" > Sep 2, 2021 <i class="unloaded">2021-09-02T20:52:00+07:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Phân tích dữ liệu bán lẻ với Spark SQL</h3><div class="text-muted small"><p> Như đã tìm hiểu ở bài viết trước về Spark SQL, Dataframe và Dataset, Spark SQL là một mô hình để xử lý dữ liệu có cấu trúc của Spark rất phổ biến. Trong bài viết này chúng ta sẽ sử dụng Spark SQL đ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/spark-sql-window-function-pivot/" class="btn btn-outline-primary" prompt="Older"><p>Window function, pivot trong Spark SQL</p></a> <a href="/posts/spark-streaming/" class="btn btn-outline-primary" prompt="Newer"><p>Spark Streaming</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://twitter.com/DeManejar">demanejar</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div></div><script type="text/javascript"> var links = document.links; for (var i = 0, linksLength = links.length; i < linksLength; i++) { if (links[i].hostname != window.location.hostname) { links[i].target = '_blank'; } } </script></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/bigdata/">Bigdata</a> <a class="post-tag" href="/tags/spark/">Spark</a> <a class="post-tag" href="/tags/crawler/">Crawler</a> <a class="post-tag" href="/tags/hdfs/">HDFS</a> <a class="post-tag" href="/tags/scrapy/">Scrapy</a> <a class="post-tag" href="/tags/hadoop/">Hadoop</a> <a class="post-tag" href="/tags/apache-hadoop/">Apache Hadoop</a> <a class="post-tag" href="/tags/ubuntu/">Ubuntu</a> <a class="post-tag" href="/tags/spark-sql/">Spark SQL</a> <a class="post-tag" href="/tags/alonhadat/">alonhadat</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js"></script> <script> $(function() { let initTheme = "default"; if ($("html[mode=dark]").length > 0 || ($("html[mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches ) ) { initTheme = "dark"; } let mermaidConf = { theme: initTheme /* <default|dark|forest|neutral> */ }; /* Markdown converts to HTML */ $("pre").has("code.language-mermaid").each(function() { let svgCode = $(this).children().html(); $(this).addClass("unloaded"); $(this).after(`<div class=\"mermaid\">${svgCode}</div>`); }); mermaid.initialize(mermaidConf); }); </script><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://demanejar.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
